# SCANN v2 UI/UX 设计文档

> **版本**: 1.1  
> **日期**: 2026-02-10  
> **框架**: PyQt5  
> **输入**: [需求文档](../../new%20requirements.md) · [架构设计](architecture.md)

---

## 目录

1. [设计目标与原则](#1-设计目标与原则)
2. [用户角色与使用场景](#2-用户角色与使用场景)
3. [信息架构](#3-信息架构)
4. [全局布局](#4-全局布局)
5. [页面/视图详细设计](#5-页面视图详细设计)
6. [**标注工具系统设计**](#6-标注工具系统设计) ← NEW
7. [组件库规范](#7-组件库规范)
8. [交互规范](#8-交互规范)
9. [快捷键体系](#9-快捷键体系)
10. [状态机与工作流](#10-状态机与工作流)
11. [视觉规范](#11-视觉规范)
12. [可访问性与响应式](#12-可访问性与响应式)
13. [需求追溯矩阵](#13-需求追溯矩阵)

---

## 1. 设计目标与原则

### 1.1 设计目标

| # | 目标 | 度量标准 |
|---|------|----------|
| G1 | **最大化图像展示** | 图像区域占窗口面积 ≥ 75% |
| G2 | **高效闪烁比对** | 新旧图切换延迟 < 16ms (60fps) |
| G3 | **零学习成本快捷键** | 核心操作单键触达，无需组合键 |
| G4 | **天文工作流无中断** | 从加载到输出报告全程不切换窗口 |
| G5 | **FITS 数据完整性** | 任何保存操作不丢失/修改 FITS 头信息 |
| G6 | **最大化标注效率** | 单样本标注 ≤ 2s，双模式兑容 v1/v2，纯键盘工作流 |

### 1.2 设计原则

1. **图像为王 (Image-First)**  
   所有控件为图像让路。侧边栏可折叠，工具栏紧贴边缘，状态信息浮层显示。

2. **渐进式披露 (Progressive Disclosure)**  
   首屏仅展示核心功能 (打开/闪烁/标记)；高级功能 (AI训练/计划任务/降噪) 通过菜单或设置面板按需展开。

3. **模态最小化 (Minimal Modality)**  
   除文件选择器和设置对话框外，所有操作在主窗口完成，不弹出模态窗口阻断工作流。

4. **状态可见性 (Status Visibility)**  
   当前显示的是新图/旧图、反色状态、闪烁状态、AI 进度，均在 UI 上有明确视觉反馈。

5. **容错与可逆 (Forgiving & Reversible)**  
   标记真/假可随时修改；处理操作仅影响显示，不修改原始 FITS 数据。

---

## 2. 用户角色与使用场景

### 2.1 用户画像

| 角色 | 描述 | 核心需求 |
|------|------|----------|
| **巡天猎手** | 业余天文爱好者，通过闪烁法寻找新天体 | 快速加载、高效闪烁比对、AI 辅助检测 |
| **跟踪观测者** | 对已发现目标进行跟踪观测并上报 MPC | 精确坐标、MPC 80 列报告生成 |
| **AI 训练员** | 标注训练数据、训练/评估模型 | 批量标记界面、训练进度监控 |

### 2.2 核心使用场景 (Use Cases)

```
UC-01  加载新旧文件夹 → 自动配对 → 浏览图像列表
UC-02  闪烁比对 → 发现可疑目标 → 标记真/假
UC-03  AI 批量检测 → 按置信度排序 → 人工复核
UC-04  右键查询外部数据库 → 排除已知天体
UC-05  生成 MPC 80列报告 → 复制/导出
UC-06  设置望远镜参数 → MPCORB 叠加显示
UC-07  批量降噪/伪平场 → 另存为 FITS
UC-08  标记训练样本 → 训练 AI 模型
UC-09  打开标注工具 → 加载三联图文件夹 → 快速分类标注 (v1模式)
UC-10  打开标注工具 → 加载 FITS图像 → 拖拽画框标注目标 (v2模式)
UC-11  AI 预标注 → 人工复核修正 → 导出标注数据集
```

---

## 3. 信息架构

```
SCANN v2
├── 📂 文件管理
│   ├── 新图文件夹
│   ├── 旧图文件夹
│   └── 保存文件夹
├── 🔭 图像浏览
│   ├── 图像配对列表
│   ├── 图像查看器 (新图/旧图切换)
│   ├── 闪烁控制
│   └── 直方图/显示调整
├── ⚡ 检测与分析
│   ├── 批量对齐
│   ├── AI 检测
│   ├── 可疑目标列表
│   └── 已知排除
├── 🌐 外部查询
│   ├── VSX / MPC / SIMBAD / TNS
│   ├── 人造卫星查询
│   └── MPC 80列报告
├── 🧠 AI 训练
│   ├── 标记管理
│   ├── 训练配置
│   └── 训练监控
├── 🏷️ 标注工具 (NEW)
│   ├── 模式选择 (v1三联图 / v2全图)
│   ├── 图像浏览器 (标注专用)
│   ├── 快速分类 (真/假/跳过)
│   ├── 边界框绘制 (v2模式)
│   ├── AI 预标注
│   ├── 标注统计/进度
│   └── 导出数据集
├── 🪐 MPCORB 叠加
│   ├── MPCORB 文件管理
│   └── 极限星等过滤
└── ⚙️ 设置
    ├── 望远镜/相机参数
    ├── 天文台信息
    ├── 检测参数
    ├── AI 参数
    └── 保存选项
```

---

## 4. 全局布局

### 4.1 主窗口线框图 (ASCII Wireframe)

```
┌─────────────────────────────────────────────────────────────────────────┐
│ 📋 菜单栏: 文件 | 处理 | AI | 查询 | 视图 | 设置 | 帮助              │
├────────┬────────────────────────────────────────────────────────────────┤
│        │  ┌─[新图 ▸]─[旧图 ▸]─────── 文件名: NGC1234_20260208.fits ┐  │
│  侧    │  │                                                         │  │
│  边    │  │                                                         │  │
│  栏    │  │                                                         │  │
│        │  │               图 像 查 看 器                            │  │
│  (可   │  │          (占据最大可用空间)                              │  │
│  折    │  │                                                         │  │
│  叠)   │  │     ○ 候选体标记 (方框/十字线)                          │  │
│        │  │     ★ MPCORB 已知小行星叠加                             │  │
│  240px │  │                                                         │  │
│        │  └─────────────────────────────────────────────────────────┘  │
│        │  ┌ 控制栏 ────────────────────────────────────────────────┐  │
│        │  │ [新图] [旧图] [✨闪烁] ●500ms  [🔄反色] [📊拉伸]     │  │
│        │  │                        ──────  [✅真Y] [❌假N] [➡下一] │  │
│        │  └────────────────────────────────────────────────────────┘  │
├────────┴────────────────────────────────────────────────────────────────┤
│ 状态栏: 新图/旧图 | 坐标 X:1024 Y:768 | RA:12h34m Dec:+56°78' | 缩放 │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.2 侧边栏布局 (可折叠)

```
┌────────────────────┐
│ 📂 文件夹         │
│ [新图文件夹] [旧图]│
│ [🔗对齐] [⚡检测]  │
├────────────────────┤
│ 📁 图像配对 (3/15) │
│ ┌────────────────┐ │
│ │● NGC1234_001   │ │
│ │  NGC1234_002   │ │
│ │  NGC1234_003   │ │
│ │  ...           │ │
│ └────────────────┘ │
├────────────────────┤
│ 🔥 可疑目标 (5)    │
│ ┌────────────────┐ │
│ │ #1 ⭐0.97      │ │
│ │  (1024, 768)   │ │
│ │ #2 ⭐0.89      │ │
│ │  (512, 400)    │ │
│ │ #3 ⭐0.73      │ │
│ │  ...           │ │
│ └────────────────┘ │
│ [复制坐标] [导出]  │
└────────────────────┘
```

### 4.3 布局分配规则

| 区域 | 最小宽度 | 策略 | 说明 |
|------|----------|------|------|
| 侧边栏 | 200px | 固定/可折叠 | `Ctrl+B` 切换显示，折叠后图像区域100% |
| 图像查看器 | 自适应 | 弹性填充 | 始终获取剩余所有空间 |
| 控制栏 | 全宽 | 固定高度 40px | 核心操作按钮 + 闪烁速度 |
| 菜单栏 | 全宽 | 固定高度 | 高级功能入口 |
| 状态栏 | 全宽 | 固定高度 24px | 实时坐标/状态信息 |

---

## 5. 页面/视图详细设计

### 5.1 主视图 — 图像浏览与闪烁

**入口**: 应用启动默认视图

**区域拆分**:

```
 ┌──────────────────────────────────────────────────┐
 │                 ImageViewerWidget                 │
 │                                                   │
 │  ┌─ OverlayHUD (浮层) ─────────────────────────┐ │
 │  │ 左上: [NEW] / [OLD] 状态标签 (半透明)       │ │
 │  │ 右上: 缩放百分比                             │ │
 │  │ 右下: 反色/闪烁状态图标                      │ │
 │  └─────────────────────────────────────────────┘ │
 │                                                   │
 │  图像内容 (QGraphicsView)                         │
 │  - 候选体方框标记 (绿色=自动, 紫色=手动)         │
 │  - 选中候选体标记 (红色加粗)                      │
 │  - MPCORB已知小行星 (灰色虚线圆 + 名称标签)      │
 │                                                   │
 └──────────────────────────────────────────────────┘
```

**状态标签设计**:

| 状态 | 标签文本 | 背景色 | 位置 |
|------|----------|--------|------|
| 显示新图 | `NEW` | `#2196F3` (蓝) 半透明 | 左上角 |
| 显示旧图 | `OLD` | `#FF9800` (橙) 半透明 | 左上角 |
| 反色开启 | `INV` 图标 | `#9C27B0` (紫) | 右下角 |
| 闪烁中 | `⚡` 脉冲动画 | — | 右下角 |

**闪烁行为规范**:
- 默认速度 500ms，可在控制栏 `NoScrollSpinBox` 中调整 (200ms ~ 1000ms，步进 100ms)
- 右侧锁定按钮防止误触：点击后禁用滑块，再次点击解锁
- 闪烁期间新旧图共享同一视口变换 (缩放/平移同步)
- 反色状态在闪烁切换时保持，直到用户再次按 `I`
- 切换图像配对时，闪烁自动停止

### 5.2 控制栏详细设计

```
┌─────────────────────────────────────────────────────────────────────┐
│ [1:新图]  [2:旧图]  │ [✨闪烁R]  ●━━━━━○ 500ms  │ [�锁定] [🔄反色I]  │
│                      │  (toggle)   (slider)        │  (toggle)  (toggle) │
│ [📊直方图拉伸]       │                              │                     │
│                      ├──────────────────────────────┤                     │
│                      │           弹性空间            │                     │
│                      ├──────────────────────────────┤                     │
│                      │ [✅真 Y]  [❌假 N]  [➡下一]  │                     │
└─────────────────────────────────────────────────────────────────────┘
```

**闪烁速度滑块**:
- 范围: 200ms ~ 1000ms
- 步进: 100ms
- 默认值: 500ms
- 右侧锁定按钮: 点击后禁用滑块，防止误触；再次点击解锁

**按钮状态矩阵**:

| 按钮 | 默认态 | 激活态 | 禁用态 |
|------|--------|--------|--------|
| 新图 | 灰底黑字 | 蓝底白字 (当前显示新图) | 灰底灰字 (未加载) |
| 旧图 | 灰底黑字 | 橙底白字 (当前显示旧图) | 灰底灰字 (未加载) |
| 闪烁 | 灰底 | 黄底 + 脉冲边框 | 灰底 (未加载) |
| 反色 | 灰底 | 紫底白字 | — |
| 标记真 | `#4CAF50` 绿底白字 | 按下凹陷 | 灰底 (无候选) |
| 标记假 | `#F44336` 红底白字 | 按下凹陷 | 灰底 (无候选) |

### 5.3 直方图拉伸面板

**触发**: 点击 `📊直方图拉伸` 按钮或菜单 `视图 > 直方图拉伸`

```
┌─ 直方图拉伸 (仅显示，不改变原始数据) ───────────────┐
│                                                       │
│  ▁▂▃▅▇█▇▅▃▂▁▁▁▁▁  (实时直方图)                      │
│  ▲                ▲                                   │
│  Black Point       White Point                        │
│                                                       │
│  黑点: [====●===========] 500    ← NoScrollSpinBox    │
│  白点: [==============●=] 60000  ← NoScrollSpinBox    │
│                                                       │
│  预设: [线性▾] [对数] [平方根] [Asinh] [自动拉伸]     │
│                                                       │
│  [重置]                            [应用到所有配对]    │
└───────────────────────────────────────────────────────┘
```

**约束**: 
- 仅临时调整显示亮度，**不改变图片原有实际像素**，**不保存**
- 拉伸参数在闪烁新旧图时同步应用
- 切换图像配对时可选择是否保留拉伸参数

### 5.4 可疑目标列表 (Suspect List Widget)

```
┌─ 🔥 可疑目标 (AI排序) ─────── [导出CSV] ───────────┐
│ ┌───┬─────────┬──────────────┬───────────┬─────────────┐ │
│ │ # │ AI 评分 │ 像素坐标      │ WCS 坐标  │ 判决      │ │
│ ├───┼─────────┼──────────────┼───────────┼─────────────┤ │
│ │ 1 │ ⭐ 0.97 │ (1024, 768)  │ 12h34m... │ ──         │ │
│ │ 2 │ ⭐ 0.89 │ (512, 400)   │ 05h12m... │ 小行星 ★   │ │
│ │ 3 │ ⭐ 0.73 │ (200, 150)   │ 19h45m... │ 卫星线 🛰️  │ │
│ │ 4 │ ⭐ 0.65 │ (800, 600)   │ 08h22m... │ 噪点 ⚡    │ │
│ │ 5 │ ⭐ 0.62 │ (350, 280)   │ 14h15m... │ 超新星 💥  │ │
│ │ 6 │ ⭐ 0.58 │ (920, 450)   │ 23h30m... │ 变星 ✦     │ │
│ │ 7 │ ⭐ 0.55 │ (180, 520)   │ 11h45m... │ 星芒 ✨     │ │
│ │ 8 │ ⭐ 0.52 │ (640, 320)   │ 16h20m... │ CMOS ❄️    │ │
│ │ 9 │ ⭐ 0.48 │ (750, 680)   │ 02h10m... │ 有对应 🔀  │ │
│ └───┴─────────┴──────────────┴───────────┴─────────────┘ │
│                                                       │
│ 📋 坐标: RA 12h34m56.7s  Dec +56°78'90"  [复制]     │
│                                                       │
│ 右键菜单:                                             │
│   查询 VSX  |  查询 MPC  |  查询 SIMBAD              │
│   查询 TNS  |  人造卫星  |  生成 MPC 报告            │
└───────────────────────────────────────────────────────┘
```

**AI判决类型** (与标注子类型一致):
- **A. 真**: 小行星 ★, 超新星 💥, 变星 ✦
- **B. 假**: 卫星线 🛰️, 噪点 ⚡, 星芒 ✨, CMOS结霜 ❄️, 有对应 🔀

**交互规则**:
- 单击选中 → 图像查看器自动居中到该候选体
- 双击 → 在当前缩放级别基础上放大一倍
- 右键 → 弹出外部查询菜单
- 坐标文字可鼠标选中复制 (使用 `CoordinateLabel`)
- 已知天体行以灰色显示，可通过筛选器隐藏

### 5.5 设置对话框 (Settings Dialog)

**触发**: 菜单 `设置 > 首选项` 或 `Ctrl+,`

采用分页标签式布局:

```
┌─ 设置 ──────────────────────────────────────────────┐
│ [望远镜/相机] [天文台] [检测参数] [AI] [保存] [MPCORB] [测量] [高级] │
├─────────────────────────────────────────────────────┤
│                                                      │
│  === 望远镜/相机参数 ===                             │
│                                                      │
│  像素大小:      [  9.0  ] μm    ← NoScrollSpinBox   │
│  像素分辨率:    [  1.23 ] ″/pix (自动计算/可覆盖)   │
│  焦距:          [ 1500  ] mm    ← NoScrollSpinBox   │
│  相机旋转角:    [  0.0  ] °     ← NoScrollSpinBox   │
│                                                      │
│  ─────────────────────────────────────               │
│                                                      │
│  === 文件夹路径 ===                                  │
│                                                      │
│  新图文件夹: [________________________] [浏览...]     │
│  旧图文件夹: [________________________] [浏览...]     │
│  保存文件夹: [________________________] [浏览...]     │
│                                                      │
│              [恢复默认]          [确定] [取消]        │
└──────────────────────────────────────────────────────┘
```

**全部 SpinBox 使用 `NoScrollSpinBox` / `NoScrollDoubleSpinBox`，禁用滚轮。**

#### 5.5.1 设置页面分页内容

| 页签 | 字段 |
|------|------|
| **望远镜/相机** | 像素大小(μm), 像素分辨率(″/pix), 焦距(mm), 相机旋转角(°) |
| **天文台** | MPC代码, 经度(°), 纬度(°), 海拔(m) |
| **检测参数** | 阈值, 最小面积, 锐度范围, 对比度, 边缘裁剪, 动态阈值, 过滤器开关 |
| **AI** | 模型路径, 拥挤场评分/计数/惩罚, 显存限制 |
| **保存** | 位深度(16/32bit) |
| **MPCORB叠加显示** | MPCORB路径, 显示已知小行星极限星等 |
| **测量** | 观测者姓名, 测量者姓名, 望远镜描述, 星表来源 |
| **高级** | 闪烁速度, 计划任务配置, HMT 目录地址 |

### 5.6 AI 训练对话框 (Training Dialog)

**触发**: 菜单 `AI > 训练模型`

```
┌─ AI 模型训练 ───────────────────────────────────────┐
│                                                      │
│  === 训练数据集 ===                                  │
│  正样本文件夹: [____________________] [浏览]   (32)  │
│  负样本文件夹: [____________________] [浏览]  (128)  │
│  验证集比例:   [ 0.2 ] ← NoScrollSpinBox            │
│                                                      │
│  === 训练参数 ===                                    │
│  Epochs:       [  50 ]     Batch Size: [  16 ]       │
│  学习率:       [0.001]     Early Stop: [  10 ]       │
│  模型输出:     [____________________] [浏览]         │
│                                                      │
│  === 训练进度 ===                                    │
│  Epoch: 23/50  ████████████░░░░░░░░  46%             │
│  Loss: 0.0342  Val Acc: 94.2%                        │
│  ┌─────────────────────────────────────────────┐     │
│  │  Loss/Accuracy 实时曲线图                    │     │
│  │                                              │     │
│  └─────────────────────────────────────────────┘     │
│                                                      │
│  [开始训练]  [暂停]  [停止]           [关闭]         │
└──────────────────────────────────────────────────────┘
```

### 5.7 批量处理对话框

**触发**: 菜单 `处理 > 批量降噪/伪平场`

```
┌─ 批量图像处理 ──────────────────────────────────────┐
│                                                      │
│  处理选项:                                           │
│  ☑ 降噪     方法: [中值滤波 ▾]                      │
│  ☑ 伪平场   核大小: [ 64 ] px                        │
│                                                      │
│  输入: 已加载的新旧图文件夹 (15 对)                  │
│  输出: [________________________] [浏览...]           │
│                                                      │
│  保存选项:                                           │
│  位深度: ○ 16-bit  ● 32-bit                          │
│  ⚠ 原始 FITS 头将完整保留                            │
│                                                      │
│  进度: ████████░░░░░░░░  8/15                        │
│                                                      │
│  [开始处理]  [取消]                                  │
└──────────────────────────────────────────────────────┘
```

### 5.8 MPC 报告预览

**触发**: 可疑目标右键菜单 `生成 MPC 报告`

```
┌─ MPC 80列观测报告 ──────────────────────────────────┐
│                                                      │
│  ┌──────────────────────────────────────────────┐    │
│  │ COD N89                                       │    │
│  │ CON 张三, 新疆天文台                                │    │
│  │ OBS 张三                                       │    │
│  │ MEA 李四                                       │    │
│  │ TEL 0.5-m f/4 reflector + CCD             │    │
│  │ ACK zhangsan@example.com                              │    │
│  │ AC2 lisi@example.com                              │    │
│  │ NET UCAC4                                     │    │
│  │                                              │    │
│  │ 天体名称: [TLE01            ]  ← 手动输入    │    │
│  │                                              │    │
│  │     TLE01    C2026 01 18.58704 02 28 24.667+27 54 16.53         18.52V      N89  │    │
│  │ ----- end -----                               │    │
│  └──────────────────────────────────────────────┘    │
│                                                      │
│  [复制到剪贴板]  [保存为 .txt]           [关闭]      │
└──────────────────────────────────────────────────────┘
```

**天体名称输入规则**:
- 首字母必须为字母，最多6个字符
- 仅允许字母数字字符，不允许空格
- 小行星: Columns 1-5 为编号 (如 00001)，无编号时为空；Columns 6-12 为临时标识 (如 TLE01)
- 彗星: Columns 1-4 为周期编号 (如 0001)，Column 5 为轨道类型 (C/P/D/X/I/A)，Columns 6-12 为临时标识
- 自然卫星: Column 1 为行星标识 (J/S/U/N)，Columns 2-4 为卫星编号，Column 5 为 "S"，Columns 6-12 为临时标识

**80列格式说明** (详细格式见《Format For Optical Astrometric Observations Of Comets, Minor Planets and Natural Satellites》文档):
- **小行星**: Columns 1-5 为零填充编号 (如 00001)，无编号时为空；Columns 6-12 为临时标识符
- **彗星**: Columns 1-4 为周期编号 (如 0001)，Column 5 为轨道类型 (C/P/D/X/I/A)，Columns 6-12 为临时标识符
- **自然卫星**: Column 1 为行星标识 (J/S/U/N)，Columns 2-4 为卫星编号，Column 5 为 "S"，Columns 6-12 为临时标识符
- **公共字段** (所有天体类型): 
  - Columns 14-15 为备注 (Note 1/Note 2)
  - Columns 16-32 为观测时间 (YYYY MM DD.ddddd)
  - Columns 33-44 为赤经 (J2000.0)，格式 "HH MM SS.ddd"
  - Columns 45-56 为赤纬 (J2000.0)，格式 "sDD MM SS.dd"
  - Columns 66-71 为星等和波段 (F5.2,A1)，如 "18.52V"
  - Columns 78-80 为观测站代码 (A3)，如 "N89"
- **COD**: 观测站代码 (Columns 78-80)，在设置「测量」页签中配置
- **CON**: 观测台信息 (Columns 14-32 可扩展)，在设置「测量」页签中配置
- **OBS**: 观测者姓名，在设置「测量」页签中配置
- **MEA**: 测量者姓名，在设置「测量」页签中配置
- **TEL**: 望远镜描述，在设置「测量」页签中配置
- **ACK**: 观测者邮箱，在设置「测量」页签中配置
- **AC2**: 测量者邮箱，在设置「测量」页签中配置
- **NET**: 星表来源，在设置「测量」页签中配置

**示例说明**:
```
     TLE01    C2026 01 18.58704 02 28 24.667+27 54 16.53         18.52V      N89
Col: 1-12    13-15  16-32             33-44       45-56           57-65  66-71    72-77  78-80
     TLE01         blanks 2026 01 18.58704  02 28 24.667+27 54 16.53 blanks  18.52V   blanks  N89
```

### 5.9 右键上下文菜单

**触发**: 在图像查看器中右键点击

```
┌─────────────────────────┐
│ 🔍 查询 VSX             │
│ 🔍 查询 MPC             │
│ 🔍 查询 SIMBAD          │
│ 🔍 查询 TNS             │
│ 🛰️ 查询人造卫星         │
│ ─────────────────────── │
│ 📝 生成 MPC 80列报告    │
│ ─────────────────────── │
│ ➕ 手动添加候选体        │
│ 🏷️ 标记为真 (Y)         │
│ 🏷️ 标记为假 (N)         │
│ ─────────────────────── │
│ 📋 复制像素坐标          │
│ 📋 复制天球坐标          │
└─────────────────────────┘
```

---

## 6. 标注工具系统设计

**天体名称输入规则** (在右键菜单中选择「生成80列」后):
- 首字母必须为字母，最多6个字符
- 仅允许字母数字字符，不允许空格
- 小行星: Columns 1-5 为编号 (如 00001)，无编号时为空；Columns 6-12 为临时标识 (如 TLE01)
- 彗星: Columns 1-4 为周期编号 (如 0001)，Column 5 为轨道类型 (C/P/D/X/I/A)，Columns 6-12 为临时标识
- 自然卫星: Column 1 为行星标识 (J/S/U/N)，Columns 2-4 为卫星编号，Column 5 为 "S"，Columns 6-12 为临时标识符

**80列格式说明** (详细格式见《Format For Optical Astrometric Observations》文档):
- **小行星**: Columns 1-5 为零填充编号 (如 00001)，无编号时为空；Columns 6-12 为临时标识符
- **彗星**: Columns 1-4 为周期编号 (如 0001)，Column 5 为轨道类型 (C/P/D/X/I/A)，Columns 6-12 为临时标识符
- **自然卫星**: Column 1 为行星标识 (J/S/U/N)，Columns 2-4 为卫星编号，Column 5 为 "S"，Columns 6-12 为临时标识符
- **公共字段** (所有天体类型): Columns 14-15 为备注，Columns 16-32 为观测时间 (YYYY MM DD.ddddd)，Columns 33-44 为赤经 (J2000.0)，Columns 45-56 为赤纬 (J2000.0)，Columns 66-71 为星等和波段，Columns 78-80 为观测站代码
- **COD**: 观测站代码 (Columns 78-80)，在设置「测量」页签中配置
- **OBS**: 观测者姓名，在设置「测量」页签中配置
- **MEA**: 测量者姓名，在设置「测量」页签中配置
- **TEL**: 望远镜描述，在设置「测量」页签中配置
- **NET**: 星表来源，在设置「测量」页签中配置

---

## 6. 标注工具系统设计

> **设计目标**: 最大化标注效率 (G6)，兼容 v1 三联图 JPG 分类与 v2 FITS 全图检测两种模式，
> 通过抽象后端实现统一交互，支持纯键盘工作流。

### 6.1 架构抽象 — AnnotationBackend

为兼容 v1 和 v2 数据格式，标注系统采用 **策略模式 (Strategy Pattern)** 将数据加载/保存与 UI 解耦：

```
┌──────────────────────────────────────────────────────────────────┐
│                    AnnotationDialog (GUI)                         │
│  ┌──────────────────────┐  ┌──────────────────────────────────┐  │
│  │ AnnotationViewer     │  │ AnnotationControlPanel           │  │
│  │ (图像预览+标注绘制)  │  │ (标签按钮/统计/进度/导出)       │  │
│  └──────────┬───────────┘  └──────────────┬───────────────────┘  │
│             │                              │                      │
│             ▼                              ▼                      │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │              AnnotationBackend (抽象接口)                    │ │
│  │  load_samples() → list[AnnotationSample]                    │ │
│  │  save_annotation(sample, label, bbox?)                      │ │
│  │  get_image_data(sample) → ndarray | PIL.Image               │ │
│  │  get_display_info(sample) → dict                            │ │
│  │  export_dataset(output_dir, format)                         │ │
│  │  get_statistics() → AnnotationStats                         │ │
│  │  supports_bbox() → bool                                     │ │
│  │  undo() / redo()                                            │ │
│  └─────────────────┬───────────────────────┬───────────────────┘ │
│                    │                       │                      │
│  ┌─────────────────▼─────────┐  ┌─────────▼──────────────────┐  │
│  │ TripletAnnotationBackend  │  │ FitsAnnotationBackend      │  │
│  │ (v1 三联图分类标注)       │  │ (v2 FITS 全图检测标注)     │  │
│  │                           │  │                             │  │
│  │ · PNG 80×240 三联图       │  │ · FITS 全图 + JSON 标注    │  │
│  │ · 二分类: real / bogus    │  │ · 边界框 + 类别标签        │  │
│  │ · 文件夹归类持久化        │  │ · JSON 文件持久化          │  │
│  │ · supports_bbox() = False │  │ · supports_bbox() = True   │  │
│  └───────────────────────────┘  └────────────────────────────┘  │
│                                                                   │
│  ┌───────────────────────────────────────────────────────────┐   │
│  │ (预留) CustomAnnotationBackend                             │   │
│  │ · 用户可扩展自定义数据格式后端                             │   │
│  └───────────────────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────────────────┘
```

#### 6.1.1 AnnotationBackend 抽象接口

```python
class AnnotationBackend(ABC):
    """标注后端抽象基类 — 隔离数据格式差异"""

    @abstractmethod
    def load_samples(self, path: str, filter: str = "all") -> list[AnnotationSample]: ...
    
    @abstractmethod
    def save_annotation(self, sample_id: str, label: str, 
                        bbox: Optional[BBox] = None, confidence: float = 1.0) -> None: ...
    
    @abstractmethod
    def get_image_data(self, sample: AnnotationSample) -> ImageData: ...
    
    @abstractmethod
    def get_display_info(self, sample: AnnotationSample) -> dict:
        """返回显示信息，如文件名、当前标签、详细类型等
        
        Returns:
            dict: {
                "file_name": str,
                "label": Optional[str],           # real/bogus
                "detail_type": Optional[str],     # asteroid/satellite_trail 等
                "label_display": str,            # "A.小行星" / "B.卫星线" 显示文本
                "has_new_image": bool,          # v2: 是否有新图
                "has_old_image": bool           # v2: 是否有旧图
            }
        """ ...
    
    @abstractmethod
    def export_dataset(self, output_dir: str, format: str = "native") -> ExportResult: ...
    
    @abstractmethod
    def get_statistics(self) -> AnnotationStats: ...
    
    @abstractmethod
    def supports_bbox(self) -> bool: ...
    
    def undo(self) -> bool: ...   # 默认基于操作栈实现
    def redo(self) -> bool: ...
```

#### 6.1.2 数据模型

```python
@dataclass
class AnnotationSample:
    id: str                          # 唯一标识
    source_path: str                 # 原始文件路径
    display_name: str                # 显示名称
    label: Optional[str] = None      # 当前标签 (real/bogus)
    detail_type: Optional[str] = None  # 详细类型: asteroid/supernova/variable_star/satellite_trail/noise/diffraction_spike/cmos_condensation/corresponding
    bboxes: list[BBox] = field(default_factory=list)  # v2 边界框列表
    ai_suggestion: Optional[str] = None    # AI 预标注建议
    ai_confidence: Optional[float] = None  # AI 置信度
    metadata: dict = field(default_factory=dict)       # 扩展元数据

@dataclass
class BBox:
    x: int; y: int; width: int; height: int
    label: str = "real"
    confidence: float = 1.0
    # 详细标注类型 (v2 FITS 全图检测)
    # A. 真类: asteroid, supernova, variable_star
    # B. 假类: satellite_trail, noise, diffraction_spike, cmos_condensation, corresponding
    detail_type: Optional[str] = None

@dataclass
class AnnotationStats:
    total: int
    labeled: int
    unlabeled: int
    label_counts: dict[str, int]   # {"asteroid": 32, "supernova": 8, "satellite_trail": 15}
    progress_percent: float
```

#### 6.1.3 v1 TripletAnnotationBackend 实现要点

| 项目 | 说明 |
|------|------|
| **输入** | PNG 三联图文件夹 (positive/negative/unlabeled) |
| **标注方式** | 二分类 + 细分类型:
│           | ├─ A. 真: 小行星 / 超新星 / 变星
│           | └─ B. 假: 卫星线 / 噪点 / 星芒 / CMOS结霜 / 有对应 |
| **持久化** | 将文件移动/复制到 `positive/` 或 `negative/` 目录 + 元数据记录 |
| **图像显示** | 80×240 PNG → 拆分为 3 个 80×80 面板并排展示 |
| **supports_bbox** | `False` — 仅分类，无边界框 |
| **导出格式** | 原生文件夹结构 / CSV 标签清单 (含详细类型) |

#### 6.1.4 v2 FitsAnnotationBackend 实现要点

| 项目 | 说明 |
|------|------|
| **输入** | FITS 图像目录 (新图/旧图配对) + JSON 标注文件 (可选，首次可为空) |
| **标注方式** | 边界框 + 详细类别标签:
│           | ├─ A. 真: 小行星 (asteroid) / 超新星 (supernova) / 变星 (variable_star)
│           | └─ B. 假: 卫星线 (satellite_trail) / 噪点 (noise) / 星芒 (diffraction_spike) / CMOS结霜 (cmos_condensation) / 有对应 |
| **持久化** | JSON 标注文件 (兼容 `FitsDetectionDataset` 格式，扩展 `detail_type` 字段) |
| **图像显示** | FITS 新旧图切换显示 + 直方图拉伸 + 标注框叠加 (标注框在新旧图间同步) |
| **supports_bbox** | `True` — 支持拖拽画框 |
| **导出格式** | JSON (原生) / COCO / YOLO / VOC XML (映射详细类型到类别 ID) |

### 6.2 标注对话框 — AnnotationDialog

**触发**: 菜单 `AI > 标注工具` 或 `Ctrl+L`

**模式**: 非模态 (不阻断主窗口操作)

#### 6.2.1 v1 模式 — 三联图快速分类

```
┌─ 🏷️ 标注工具 — 三联图分类模式 ──────────────────────────────────────────┐
│                                                                           │
│  模式: [● v1 三联图分类 ▾]   数据集: [/dataset/unlabeled] [浏览...]      │
│                                                                           │
│  ┌─ 三联图预览 ──────────────────────────────────────────────────────┐   │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐                   │   │
│  │  │            │  │            │  │            │                   │   │
│  │  │  差异图     │  │  新图      │  │  参考图    │                   │   │
│  │  │  (放大)    │  │  (放大)    │  │  (放大)    │                   │   │
│  │  │            │  │            │  │            │                   │   │
│  │  └────────────┘  └────────────┘  └────────────┘                   │   │
│  │                                                                    │   │
│  │  文件名: REAL_NGC1234_20260208_001.png                            │   │
│  │  AI 建议: ⭐ 0.92 → 真                                           │   │
│  └────────────────────────────────────────────────────────────────────┘   │
│                                                                           │
│  ┌─ 快速标签 ──────────────────────────────────────────────────────┐   │
│  │  │ A. 真 ————————————————┐   B. 假 ——————————————┐    │   │
│  │  │ [小行星 ★ Y1]          │   [卫星线 🛰️ N1]   │    │   │
│  │  │ [超新星 💥 Y2]          │   [噪点 ⚡ N2]      │    │   │
│  │  │ [变星 ✦ Y3]            │   [星芒 ✨ N3]      │    │   │
│  │  │                         │   [CMOS结霜 ❄️ N4] │    │   │
│  │  │                         │   [有对应 🔀 N5]   │    │   │
│  │  └─────────────────────────┘   └──────────────────────┘   │   │
│  │  └────────────────────────────────────────────────────────────┘   │
│  │                                                                       │   │
│  │  ┌─ 操作 ──────────────────────────────┐  ┌─ 统计 ─────────────────┐    │
│  │  │                                     │  │                         │    │
│  │  │  [⏭ 跳过 (S)]                     │  │  总计:  250             │    │
│  │  │                                     │  │  已标注: 147 (58.8%)    │    │
│  │  │  [◀ 上一个 (Z)]  [▶ 下一个 (Space)]│  │  ├ A.真: 42              │    │
│  │  │                                     │  │  │ 小行星:32 超新星:8   │    │
│  │  │  [↩ 撤销 Ctrl+Z] [↪ 重做 Ctrl+Y] │  │  │ 变星:2               │    │
│  │  │                                     │  │  └ B.假: 105            │    │
│  │  │  ☑ 标注后自动下一个                 │  │  │ 卫星线:15 噪点:60...  │    │
│  │  │  ☑ AI 预标注建议                    │  │  未标注: 103            │    │
│  │  │                                     │  │                         │    │
│  │  └─────────────────────────────────────┘  │  ████████████░░░░  59%  │    │
│  │                                         └─────────────────────────┘    │
│                                                                           │
│  筛选: [○全部 ●未标注 ○A.真 ○B.假]  排序: [默认▾ | AI置信度 | 文件名]   │
│                                                                           │
│  [导出数据集...]  [批量AI预标注...]                    [关闭]             │
└───────────────────────────────────────────────────────────────────────────┘
```

**效率优化要点**:
- `Y1-Y3` / `N1-N5` 子类型快捷标注 + 自动跳转 → **单样本 < 1 秒**
- `Z` 快速回退上一个 (支持修改已标注)
- `S` 跳过当前 (保持未标注)
- AI 预标注: 低置信度优先排序，减少无意义标注
- 三联图放大显示: 80×80 → 适配窗口大小 (双线性插值)
- 筛选器: 只看未标注 / 只看已标注 / 按 AI 置信度排序

#### 6.2.2 v2 模式 — FITS 全图检测标注

```
┌─ 🏷️ 标注工具 — FITS 全图检测模式 ──────────────────────────────────────┐
│                                                                           │
│  模式: [● v2 FITS全图检测 ▾]   数据集: [/fits_data] [浏览]  标注文件: ● │
│                                                                           │
│  图像对: [NEW 旧图 1] [NEW 新图 2] ◆  [⚡闪烁切换 1/2]               │
│                                                                           │
│  ┌─ 图像查看器 (标注模式) ────────────────────┐  ┌─ 标注列表 ─────────┐ │
│  │                                             │  │                     │ │
│  │  ┌───────────────────────────────────────┐  │  │ # │ 标签   │ 位置   │ │
│  │  │                                       │  │  │───┼────────┼────────│ │
│  │  │    FITS 图像显示 (可切换新旧图)        │  │  │ 1 │ 小行星 │ 102,45 │ │
│  │  │    (直方图拉伸 + 反色支持)             │  │  │ 2 │ 卫星线 │ 340,67 │ │
│  │  │                                       │  │  │ 3 │ 超新星 │ 789,23 │ │
│  │  │    ┌─────┐   绿色=真                   │  │  │ 4 │ ──    │ 512,34 │ │
│  │  │    │ 目标 │   红色=假                   │  │  │                     │ │
│  │  │    └─────┘   黄色=未标注                │  │  │ [删除选中]          │ │
│  │  │                                       │  │  │ [修改标签]          │ │
│  │  │    ╔═════╗   选中=紫色加粗             │  │  │                     │ │
│  │  │    ║选中框║   标注框在新旧图同步显示      │  │  │ ── 当前标注 ──     │ │
│  │  │    ╚═════╝                             │  │  │ 大小: 24×24 px     │ │
│  │  │                                       │  │  │ 详细类型: [小行星▾] │ │
│  │  └───────────────────────────────────────┘  │  │                     │ │
│  │                                             │  └─────────────────────┘ │
│  │  绘制: [□框选B] [○点标Q] [✋移动V]           │                          │
│  └─────────────────────────────────────────────┘                          │
│                                                                           │
│  ┌─ 快速标签 ──────────────────────────────────────────────────────┐   │
│  │ A. 真 —─────────────────┐   B. 假 ─────────────────┐   │
│  │ [小行星 ★ Y1]           │   [卫星线 🛰️ N1]     │   │
│  │ [超新星 💥 Y2]           │   [噪点 ⚡ N2]        │   │
│  │ [变星 ✦ Y3]             │   [星芒 ✨ N3]        │   │
│  │                          │   [CMOS结霜 ❄️ N4]   │   │
│  │                          │   [有对应 🔀 N5]     │   │
│  └──────────────────────────┘   └──────────────────────┘   │
│  └────────────────────────────────────────────────────────────┘   │
│                                                                           │
│  ┌─ 工具栏 ──────────────────────────────────────────────────────────┐   │
│  │ [◀上一图] [▶下一图]  │ 2/15 │  [↩撤销] [↪重做]  │  统计:        │   │
│  │                       │      │                    │  A.真:5  B.假:3   │   │
│  │ [🔍AI预标注]  [⚡批量]│      │  [📊直方图拉伸]    │  本图:8  总: 42  │   │
│  └────────────────────────────────────────────────────────────────────┘   │
│                                                                           │
│  [保存标注 Ctrl+S]  [导出数据集...]                          [关闭]      │
└───────────────────────────────────────────────────────────────────────────┘
```

**标注类型详情**:

| 大类 | 快捷键 | 子类型 | 内部值 | 说明 |
|------|--------|--------|--------|------|
| **A. 真** | Y1 | 小行星 | `asteroid` | 小行星、彗星等移动天体 |
| **A. 真** | Y2 | 超新星 | `supernova` | 暂现源新星 |
| **A. 真** | Y3 | 变星 | `variable_star` | 周期/非周期变星 |
| **B. 假** | N1 | 卫星线 | `satellite_trail` | 人造卫星划过轨迹 |
| **B. 假** | N2 | 噪点 | `noise` | 图像噪点/热点 |
| **B. 假** | N3 | 星芒 | `diffraction_spike` | 衍射芒 |
| **B. 假** | N4 | CMOS结霜 | `cmos_condensation` | 传感器结霜伪影 |
| **B. 假** | N5 | 有对应 | `corresponding` | 新旧图均有，亮度差异大/对齐后旋转等 |

**图像切换规则**:
- 标注框同时显示在新图和旧图上 (基于像素坐标)
- 绘制/编辑标注框时，当前显示图像作为参考
- 点击 [闪烁切换 1/2] 或按 `Tab` 可快速在新旧图间切换，辅助判断
- 切换图像不影响标注框位置 (像素坐标不变)
- 支持新旧图并排对比模式 (窗口宽度 > 2000px 时自动启用)

**绘制工具规范**:

| 工具 | 快捷键 | 行为 | 光标 |
|------|--------|------|------|
| 框选 | `B` | 左键拖拽画矩形边界框 | 十字线 |
| 点标 | `Q` | 左键单击，自动生成固定大小框 (默认 30×30px) | 准星 |
| 移动 | `V` | 拖拽已有框调整位置/大小 | 箭头 |
| 缩放 | 滚轮 | 缩放图像 (标注框同步缩放) | 放大镜 |
| 平移 | 中键拖拽 | 平移图像视口 | 手型 |
| 删除 | `Del` / `D` | 删除当前选中标注框 | — |

**边界框交互**:
- 拖拽创建: 左键按下→拖拽→释放，最小尺寸 5×5px
- 八向缩放手柄: 四角 + 四边中点
- 标签快捷赋值:
│           ├─ 按 `Y` 或 `Y+数字` 选择真类子类型 (1=小行星, 2=超新星, 3=变星)
│           └─ 按 `N` 或 `N+数字` 选择假类子类型 (1=卫星线, 2=噪点, 3=星芒, 4=CMOS, 5=有对应)
- 或右键标注框 → 弹出详细类型菜单 (A.真 / B.假 子菜单)
- 自动吸附: 框边靠近图像边缘时自动对齐 (可关闭)

### 6.3 AI 预标注流程

```
用户点击 [AI预标注]
  ↓
选择模型文件 (或使用已加载模型)
  ↓
后台线程:
  ├─ v1: 遍历三联图 → SCANNClassifier → 输出置信度
  └─ v2: FITS全图 → SCANNDetector → 输出检测框+置信度
  ↓
结果写入 AnnotationSample.ai_suggestion / ai_confidence
  ↓
UI 更新:
  ├─ v1: 显示 AI 建议标签 + 置信度 (⭐0.92 → 真)
  └─ v2: 在图像上绘制 AI 检测框 (虚线+置信度标签)
  ↓
用户可:
  ├─ 接受 AI 建议 (按 Enter / 点击 [接受])
  ├─ 修改标签 (按 Y/N 覆盖)
  └─ 删除误检框 (按 Del)
```

**批量 AI 预标注**:

```
┌─ AI 批量预标注 ────────────────────────────────────┐
│                                                      │
│  模型:    [best_model.pth            ] [浏览]        │
│  阈值:    [ 0.5 ] ← 低于此置信度不标注               │
│  设备:    [● CUDA  ○ CPU]                            │
│                                                      │
│  策略:                                               │
│  ○ 仅标注未标注样本                                  │
│  ● 全部重新预标注 (不覆盖已有人工标注)               │
│  ○ 全部重新预标注 (覆盖所有)                         │
│                                                      │
│  进度: ████████████░░░░░░░░  120/250  48%            │
│                                                      │
│  [开始]  [取消]                                      │
└──────────────────────────────────────────────────────┘
```

### 6.4 数据集导出

```
┌─ 导出标注数据集 ────────────────────────────────────┐
│                                                      │
│  === 导出设置 ===                                    │
│                                                      │
│  输出目录: [________________________] [浏览...]       │
│                                                      │
│  格式:                                               │
│  ● 原生格式 (v1: 文件夹分类 / v2: JSON)             │
│  ○ COCO JSON  (仅v2, 目标检测通用格式)              │
│  ○ YOLO TXT   (仅v2, 归一化坐标)                    │
│  ○ VOC XML    (仅v2, Pascal VOC 格式)               │
│  ○ CSV 清单   (通用, 文件路径+标签)                  │
│                                                      │
│  筛选:                                               │
│  ☑ 仅导出已标注样本                                  │
│  ☐ 包含 AI 预标注 (未人工确认)                       │
│                                                      │
│  训练/验证集拆分:                                    │
│  ☑ 自动拆分   验证集比例: [ 0.2 ]                    │
│                                                      │
│  === 导出预览 ===                                    │
│  将导出: 真 42 + 假 105 = 147 样本                   │
│  训练集: 118  验证集: 29                             │
│                                                      │
│  [导出]                                   [取消]     │
└──────────────────────────────────────────────────────┘
```

### 6.5 标注快捷键 (标注对话框内)

| 快捷键 | 动作 | 模式 | 说明 |
|--------|------|------|------|
| `Y` | 标记为真 (real) | 通用 | v1=分类, v2=选中框标签 |
| `N` | 标记为假 (bogus) | 通用 | v1=分类, v2=选中框标签 |
| `Space` | 跳过/下一个 | v1 | 不标注，前进到下一样本 |
| `Z` | 上一个样本 | v1 | 回退查看/修改 |
| `Enter` | 接受 AI 建议 | 通用 | 采纳 AI 预标注结果 |
| `B` | 框选工具 | v2 | 拖拽画矩形 |
| `Q` | 点标工具 | v2 | 单击放置固定大小框 |
| `V` | 移动工具 | v2 | 选择/移动已有框 |
| `D` / `Del` | 删除选中框 | v2 | 删除当前选中的标注框 |
| `Tab` | 切换到下一个框 | v2 | 在标注列表中循环选中 |
| `Ctrl+Z` | 撤销 | 通用 | 撤销上一步标注操作 |
| `Ctrl+Y` | 重做 | 通用 | 重做已撤销操作 |
| `Ctrl+S` | 保存 | 通用 | 保存当前标注到磁盘 |
| `←` / `→` | 上/下一张图 | v2 | 切换 FITS 图像 |
| `Ctrl+L` | 打开标注工具 | 全局 | 从主窗口启动 |

### 6.6 标注模式切换与自适应

标注对话框根据选择的模式自动调整 UI 布局：

```
模式切换时:
  ↓
v1 三联图模式:
  ├─ 隐藏: 绘制工具栏, 标注列表面板, 直方图拉伸
  ├─ 显示: 三联图放大预览 (3面板并排), 分类按钮加大
  ├─ 图像区域: 居中显示, 无缩放/平移交互
  └─ 焦点: 分类操作 (Y/N/Space), 最大化吞吐量

v2 FITS全图模式:
  ├─ 显示: 绘制工具栏, 标注列表面板, 直方图拉伸
  ├─ 隐藏: 三联图分割预览
  ├─ 图像区域: 全功能查看器 (缩放/平移/标注框绘制)
  └─ 焦点: 精确框选 + 标签赋值

通用元素 (始终显示):
  ├─ 模式选择下拉框
  ├─ 数据集路径
  ├─ 统计面板 (总计/已标注/进度条)
  ├─ 撤销/重做按钮
  └─ 导出按钮
```

### 6.7 标注状态机

```
┌──────────┐  加载数据集  ┌───────────┐
│ NoData   │─────────────►│  Ready    │
│ (无数据) │              │ (待标注)  │
└──────────┘              └─────┬─────┘
                                │
                    ┌───────────┼───────────┐
                    │           │           │
                    ▼           ▼           ▼
            ┌──────────┐ ┌──────────┐ ┌──────────┐
            │Classifying│ │ Drawing  │ │ AI Pre-  │
            │(v1分类中)  │ │(v2画框中)│ │ labeling │
            └──────┬────┘ └────┬─────┘ │(AI预标注)│
                   │           │       └────┬─────┘
                   │           │            │
                   ▼           ▼            ▼
            ┌─────────────────────────────────────┐
            │            Annotated                 │
            │  (已标注 — 可继续修改/导出)          │
            └──────────────────┬──────────────────┘
                               │
                        导出/保存
                               ▼
                        ┌──────────┐
                        │ Exported │
                        │ (已导出) │
                        └──────────┘
```

### 6.8 标注数据流

```
三联图文件夹 ──→ TripletAnnotationBackend ──┐
(v1 PNG)         load_samples()              │
                                             ├──→ AnnotationDialog
FITS 图像目录 ──→ FitsAnnotationBackend ─────┘         │
(v2 FITS)         load_samples()                        │
                                                        ▼
                                                   用户标注
                                                   (Y/N/画框)
                                                        │
                  ┌─────────────────────────────────────┤
                  │                                     │
                  ▼                                     ▼
          save_annotation()                     export_dataset()
          (实时持久化)                           (批量导出)
                  │                                     │
          ┌───────┼────────┐                    ┌───────┼───────────┐
          ▼                ▼                    ▼       ▼           ▼
    positive/      annotations.json        文件夹分类  COCO JSON   YOLO TXT
    negative/      (v2 格式)               (v1)        (v2)        (v2)
    (v1 格式)
```

---

## 7. 组件库规范

### 7.1 自定义 Widget 清单

| 组件 | 类名 | 文件 | 说明 |
|------|------|------|------|
| FITS图像查看器 | `FitsImageViewer` | `image_viewer.py` | QGraphicsView 子类，支持中键拖拽/滚轮缩放/标记绘制 |
| 可复制坐标标签 | `CoordinateLabel` | `widgets/coordinate_label.py` | 可选中复制文本的 QLabel |
| 无滚轮SpinBox | `NoScrollSpinBox` | `widgets/no_scroll_spinbox.py` | 屏蔽 wheelEvent |
| 无滚轮DoubleSpinBox | `NoScrollDoubleSpinBox` | `widgets/no_scroll_spinbox.py` | 屏蔽 wheelEvent |
| 浮层状态标签 | `OverlayLabel` | `widgets/overlay_label.py` | **新增** 半透明浮层，显示 NEW/OLD/INV 状态 |
| 可疑目标表格 | `SuspectTableWidget` | `widgets/suspect_table.py` | **新增** 带排序/筛选/右键菜单的目标列表 |
| 直方图面板 | `HistogramPanel` | `widgets/histogram_panel.py` | **新增** 实时直方图 + 黑白点滑块 |
| 闪烁速度滑块 | `BlinkSpeedSlider` | `widgets/blink_speed_slider.py` | **新增** 带数值显示的速度控制 |
| 可折叠侧边栏 | `CollapsibleSidebar` | `widgets/collapsible_sidebar.py` | **新增** 可折叠/展开的侧面板 |
| MPCORB叠加层 | `MpcorbOverlay` | `widgets/mpcorb_overlay.py` | **新增** 在图像上绘制已知小行星位置 |
| 标注图像查看器 | `AnnotationViewer` | `widgets/annotation_viewer.py` | **新增** 支持边界框绘制/编辑的图像查看器，兼容三联图和FITS |
| 三联图预览面板 | `TripletPreviewPanel` | `widgets/triplet_preview.py` | **新增** 80×80 三联图放大并排显示 |
| 标注统计面板 | `AnnotationStatsPanel` | `widgets/annotation_stats.py` | **新增** 实时标注进度/类别统计 |
| 标注列表 | `AnnotationListWidget` | `widgets/annotation_list.py` | **新增** v2模式边界框列表 + 属性编辑 |
| 绘制工具栏 | `DrawToolBar` | `widgets/draw_toolbar.py` | **新增** 框选/点标/移动/缩放工具切换 |

### 7.2 组件状态设计

#### FitsImageViewer 状态图

```
                    ┌───────────┐
                    │   Empty   │  ← 初始状态
                    └─────┬─────┘
                          │ load_image()
                    ┌─────▼─────┐
              ┌────►│ Viewing   │◄────┐
              │     └──┬──┬──┬──┘     │
              │        │  │  │        │
    show_new()│  blink │  │  │ zoom() │ pan()
              │        │  │  │        │
              │     ┌──▼──┘  └──▼──┐  │
              │     │Blinking│  │Zoom│──┘
              │     └──┬─────┘  └───┘
              │        │ stop_blink()
              └────────┘
```

#### AnnotationViewer 状态图 (v2 FITS 标注模式)

```
                    ┌───────────┐
                    │   Empty   │  ← 无标注图像
                    └─────┬─────┘
                          │ load_annotation_pair()
                    ┌─────▼─────┐
              ┌────►│Annotating │◄────┐
              │     │(标注中)  │     │
              │     └──┬──┬──┘     │
              │        │  │           │
          viewing │ new/old │ bbox_edit │
           浏览   │ switching  编辑边界框
              │     ┌──▼──┘  └───┐  │
              │     │ ViewingNew     │  │
              │     │(查看新图时)    │  │
              │     └──┬────────────┘  │
              │        │               │
              │     ┌──▼──────────────┐
              │     │ ViewingOld     │
              │     │(查看旧图时)    │
              │     └──┬────────────┘
              │        │ undo/redo
              └────────┴──────────────┘
```

**状态说明**:
- `Empty`: 无图像加载
- `Annotating`: 已加载图像对，可进行标注
- `ViewingNew`: 当前显示新图 (NEW 状态标签)
- `ViewingOld`: 当前显示旧图 (OLD 状态标签)
- `bbox_edit`: 正在编辑边界框 (拖拽/缩放/移动)
- **关键**: 新旧图切换不影响标注框状态，标注框在两种状态下均显示

---

## 8. 交互规范

### 8.1 鼠标交互

| 操作 | 区域 | 行为 | 说明 |
|------|------|------|------|
| **左键单击** | 图像 | 选中最近的候选体 / 获取坐标 | 状态栏更新坐标 |
| **左键双击** | 候选列表 | 图像居中并放大到候选体 | 200×200px 视口 |
| **中键按住拖拽** | 图像 | 平移图像 | 新旧图同步平移 |
| **右键单击** | 图像 | 弹出上下文查询菜单 | 见 §5.9 |
| **滚轮** | 图像 | 缩放 (以鼠标位置为锚点) | 缩放因子 1.25x |
| **滚轮** | SpinBox | **无效** (已禁用) | 防止误操作 |

### 8.2 拖拽同步规范

闪烁期间平移/缩放操作必须对新旧图同步生效:

```
用户中键拖拽 → ImageViewer 记录 viewport transform
             → BlinkService.tick() 切换图像
             → 新图像应用相同 viewport transform
             → 视觉上: 内容切换，位置不变
```

**实现要求**: `FitsImageViewer` 内部仅维护一个 viewport 变换矩阵，切换新旧图时仅替换像素数据，不重置变换。

### 8.3 反色交互规范

```
用户按 I → toggle_invert() → 反色状态翻转
         → 当前显示图像立即刷新为反色/正常
         → 后续切换图像/闪烁时，沿用当前反色状态
         → 切换到下一组图像配对时，反色状态保持
         → 再次按 I 才关闭反色
```

### 8.4 外部查询交互流程

```
右键点击图像某点
  ↓
弹出上下文菜单 (§5.9)
  ↓
用户选择 "查询 MPC"
  ↓
后台线程发起 HTTP 查询
  ↓                       ↓
成功: 弹出结果浮窗       失败: 状态栏提示 "查询超时"
  ↓
"MPC 查询结果" 浮窗:
  - 匹配到的天体列表
  - [排除此天体] 按钮
  - [生成 80列报告] 按钮
```

### 8.5 标注模式新旧图切换交互 (v2 专用)

**目的**: v2 FITS 全图标注需要在新旧图之间快速切换，辅助判断目标真伪

**交互流程**:

```
用户在 v2 标注模式下加载图像对 (新图 + 旧图)
  ↓
默认显示: 新图 (左上角显示 [NEW] 标签)
  ↓
标注框绘制:
  ├─ 基于像素坐标 (固定)
  ├─ 同时叠加在新图和旧图上 (视觉同步)
  └─ 标注框颜色/样式不变 (不随图像切换而变)
  ↓
用户点击 [闪烁切换 1/2] 或按 Tab
  ↓
图像切换: NEW → OLD (左上角标签变为 [OLD])
  ↓
标注框位置不变 (像素坐标不变)
  ↓
用户继续标注/编辑标注框
  ↓
可选: 右键标注框 → 弹出「在新图查看」/「在旧图查看」菜单
       → 仅显示该标注框在对应图像上的效果 (其他标注框隐藏)
  ↓
重复直到完成本图标注 → 切换下一组图像对
```

**快捷键**:

| 快捷键 | 动作 | 说明 |
|--------|------|------|
| `Tab` | 切换新图/旧图 | 标注框位置不变，辅助判断 |
| `1` | 显示新图 | 跳到新图 |
| `2` | 显示旧图 | 跳到旧图 |
| `F5` / `R` | 闪烁新图/旧图 | 以当前闪烁速度自动切换 (仅查看，不标注) |

**视觉反馈**:

| 状态 | 左上角标签 | 背景色 | 说明 |
|------|-----------|--------|------|
| 显示新图 | `NEW` | `#2196F3` (蓝) 半透明 | 当前参考为新图 |
| 显示旧图 | `OLD` | `#FF9800` (橙) 半透明 | 当前参考为旧图 |
| 闪烁中 | `⚡` 脉冲动画 | — | 自动切换模式 |

**并排对比模式**:

当窗口宽度 > 2000px 时，自动启用并排对比:

```
┌─ 图像查看器 (标注模式 — 并排对比) ──────────────────────────┐
│                                                                   │
│  ┌─────────────────────┐  ┌─────────────────────┐              │
│  │   NEW (新图)       │  │   OLD (旧图)       │              │
│  │                    │  │                    │              │
│  │  ┌─────┐         │  │  ┌─────┐         │              │
│  │  │ 目标 │         │  │  │ 目标 │         │              │
│  │  └─────┘         │  │  └─────┘         │              │
│  │                    │  │                    │              │
│  │  [标注框1]        │  │  [标注框1]        │              │
│  │  [标注框2]        │  │  [标注框2]        │              │
│  └─────────────────────┘  └─────────────────────┘              │
│                                                                   │
│  同步操作: 绘制/编辑/删除标注框会同时在两侧显示                │
│  焦点: 左侧 (NEW) 为标注主区域，右侧为参考辅助                │
│  切换焦点: Ctrl+Tab (NEW→OLD) 或 Ctrl+Shift+Tab (OLD→NEW)     │
└───────────────────────────────────────────────────────────────────┘
```

**约束**:
- 标注框始终使用统一像素坐标系统 (不因图像切换而改变)
- 在并排模式下，一侧的标注操作会实时同步到另一侧
- 用户可选择在单屏模式 (节省空间) / 并排模式 (快速对比) 间切换

### 8.5 标注工具交互规范

#### 8.5.1 v1 三联图标注流程

```
用户打开标注工具 (Ctrl+L / 菜单 AI > 标注工具)
  ↓
选择模式: v1 三联图分类
  ↓
浏览选择三联图文件夹
  ↓
TripletAnnotationBackend.load_samples()
  ↓
显示第一张三联图 (放大显示 3×80×80)
  ↓
用户按 Y1-Y3 (真-子类型) / N1-N5 (假-子类型) / S (跳过)
  ↓                                  ↓
save_annotation()                自动跳转下一样本
  ↓                               (auto-advance 开启时)
文件移动到 positive/negative/
  ↓
统计面板实时更新
  ↓
重复直到全部标注完成 → 导出数据集
```

**关键效率指标**:
- 单样本标注延迟: 用户按键 → 文件保存 + 下一张加载 < 200ms
- 纯键盘工作流: Y/N/Space/Z 四键完成所有操作
- 无需鼠标交互: 标注过程中双手不离开键盘

#### 8.5.2 v2 FITS 全图标注流程

```
用户打开标注工具 (Ctrl+L / 菜单 AI > 标注工具)
  ↓
选择模式: v2 FITS全图检测
  ↓
浏览选择 FITS 图像目录
  ↓
FitsAnnotationBackend.load_samples()
  ↓
显示第一张 FITS 图像 (直方图拉伸)
  ↓
用户切换绘制工具 (B=框选, Q=点标, V=移动)
  ↓
左键拖拽画框 / 左键单击点标
  ↓
自动弹出标签选择: [Y1 小行星] [Y2 超新星] [Y3 变星] [N1 卫星线] [N2 噪点] [N3 星芒] [N4 CMOS] [N5 有对应]
  ↓
save_annotation() → annotations.json 更新
  ↓
标注列表面板实时更新
  ↓
切换下一张 FITS 继续标注 → 导出数据集
```

**绘制反馈规范**:
- 拖拽画框时: 实时显示虚线矩形 + 尺寸标注 (W×H px)
- 释放后: 虚线变实线，边框色=子类型标签色 (详见 §11.2)
- Hover: 边框加亮 + 工具提示 (tooltip) 显示标签+子类型+置信度
- 选中: 紫色加粗边框 + 八向缩放手柄
- 删除: 淡出动画 (150ms)

---

## 9. 快捷键体系

### 9.1 全局快捷键 (窗口焦点内)

所有快捷键使用 `Qt.WindowShortcut`，仅在程序窗口获得焦点时生效。

| 快捷键 | 动作 | 分类 | 条件 |
|--------|------|------|------|
| `R` | 切换闪烁 开/关 | 核心 | 已加载图像 |
| `I` | 切换反色 | 核心 | 已加载图像 |
| `Y` | 标记当前候选为真 | 标记 | 有选中候选 |
| `N` | 标记当前候选为假 | 标记 | 有选中候选 |
| `1` | 显示新图 | 切换 | 已加载图像 |
| `2` | 显示旧图 | 切换 | 已加载图像 |
| `滚轮↑` | 放大 | 缩放 | 鼠标在图像区域 |
| `滚轮↓` | 缩小 | 缩放 | 鼠标在图像区域 |
| `中键拖拽` | 平移图像 | 导航 | 鼠标在图像区域 |

### 9.2 扩展快捷键

| 快捷键 | 动作 | 分类 |
|--------|------|------|
| `Ctrl+O` | 打开新图文件夹 | 文件 |
| `Ctrl+Shift+O` | 打开旧图文件夹 | 文件 |
| `Ctrl+B` | 切换侧边栏折叠 | 视图 |
| `Ctrl+,` | 打开设置 | 设置 |
| `Space` | 下一个候选体 | 导航 |
| `Shift+Space` | 上一个候选体 | 导航 |
| `F` | 适配窗口 (Fit to View) | 缩放 |
| `Ctrl+S` | 保存当前图像 | 文件 |
| `←` / `→` | 上/下一组图像配对 | 导航 |
| `Ctrl+E` | 导出 MPC 报告 | 报告 |
| `Ctrl+L` | 打开标注工具 | 标注 |

### 9.3 标注工具快捷键 (标注对话框内)

> 完整快捷键表见 §6.5。以下为核心效率快捷键摘要。

| 快捷键 | 动作 | 模式 |
|--------|------|------|
| `Y1-Y3` | A.真子类型 + 自动下一个 | v1 |
| `N1-N5` | B.假子类型 + 自动下一个 | v1 |
| `Space` | 跳过当前样本 | v1 |
| `Z` | 回退上一个样本 | v1 |
| `B` / `Q` / `V` | 框选/点标/移动工具 | v2 |
| `D` / `Del` | 删除选中标注框 | v2 |
| `Tab` / `1` / `2` / `F5` | 新旧图切换 | v2 |
| `Ctrl+Z` / `Ctrl+Y` | 撤销/重做 | 通用 |

### 9.4 快捷键冲突预防

- 单字母快捷键 (`R`, `I`, `Y`, `N`) 在文本输入框获得焦点时自动失效
- 实现: `QAction.setShortcutContext(Qt.WindowShortcut)` + 文本框 focus 判断

---

## 10. 状态机与工作流

### 10.1 应用主状态机

```
┌─────────┐   加载文件夹   ┌──────────┐  批量对齐   ┌──────────┐
│  Empty  │──────────────►│  Loaded  │────────────►│ Aligned  │
│ (初始)  │                │ (已配对) │              │ (已对齐) │
└─────────┘                └──────────┘              └────┬─────┘
                                                          │
                                          ┌───────────────┘
                                          │ AI检测
                                          ▼
                            ┌──────────┐     ┌──────────────┐
                            │Detecting │────►│  Reviewing   │
                            │(检测中)  │     │ (复核候选体) │
                            └──────────┘     └───────┬──────┘
                                                      │
                                            标记/排除/导出
                                                      ▼
                                             ┌────────────┐
                                             │  Reported  │
                                             │ (已输出)   │
                                             └────────────┘
```

### 10.2 可疑目标列表操作状态

```
候选体生成 → [UNKNOWN] ──Y──→ [REAL]
                  │              ↕ (可反复修改)
                  N              Y
                  ↓              
               [BOGUS] ←────────┘

另: 如匹配 MPCORB → [KNOWN] (灰色，不参与 Y/N 标记)
```

### 10.3 数据流概览

```
新图文件夹 ──┐                                     ┌──→ 可疑目标列表
             ├─→ 配对 → 对齐 → 候选检测 → AI评分 ──┤
旧图文件夹 ──┘        ↑                    ↑        ├──→ MPCORB叠加显示
                      │                    │        └──→ MPC 80列报告
               仅移动旧图              CUDA推理
                                       ≤ 8GB
                                       
MPCORB文件 ────→ 位置计算 → 星等过滤 → 已知排除 ───→ 可疑列表精简
```

---

## 11. 视觉规范

### 11.1 色彩体系

采用**暗色主题 (Dark Theme)**，减少眼疲劳，对比度利于天文图像观察。

| 用途 | 色值 | 示例 |
|------|------|------|
| 背景 - 主 | `#1E1E1E` | 窗口背景 |
| 背景 - 图像区域 | `#141414` | 图像查看器背景 |
| 背景 - 面板 | `#252526` | 侧边栏/控制栏 |
| 文字 - 主 | `#D4D4D4` | 正文文字 |
| 文字 - 次 | `#808080` | 次要信息 |
| 强调 - 蓝 (新图) | `#2196F3` | 新图按钮激活、NEW标签 |
| 强调 - 橙 (旧图) | `#FF9800` | 旧图按钮激活、OLD标签 |
| 强调 - 绿 (真) | `#4CAF50` | 标记真、自动检测候选 |
| 强调 - 红 (假/选中) | `#F44336` | 标记假、选中候选框 |
| 强调 - 紫 (手动) | `#9C27B0` | 手动标记、反色状态 |
| 强调 - 灰 (已知) | `#757575` | 已知天体 |
| 强调 - 黄 (警告/AI) | `#FFEB3B` | 批量检测按钮、AI高分 |
| 边框 | `#3C3C3C` | 面板分割线 |

### 11.2 标记视觉样式

| 标记类型 | 形状 | 颜色 | 线宽 | 说明 |
|----------|------|------|------|------|
| AI 自动检测 | 圆圈 + 编号 | 绿色 `#4CAF50` | 2px | 默认标记 |
| 手动添加 | 圆圈 + 编号 | 紫色 `#9C27B0` | 2px | 用户手动标注 |
| 当前选中 | 圆圈 + 十字线 | 红色 `#F44336` | 3px | 加粗 + 十字线突出 |
| 已知天体 | 虚线圆 + 名称 | 灰色 `#757575` | 1px | 可隐藏 |
| MPCORB 叠加 | 虚线圆 + 名称 | 青色 `#00BCD4` | 1px | MPCORB 已知小行星 |
| 已标记为真 | 圆圈 + ✓ | 绿色 `#4CAF50` | 2px | 带对勾标识 |
| 已标记为假 | 圆圈 + ✗ | 红色半透明 | 1px | 降低视觉优先级 |

#### v2 标注框详细类型视觉样式

| 标注框类型 | 大类 | 形状 | 颜色 | 线宽 | 标识 | 说明 |
|-----------|------|------|------|------|------|------|
| 标注框-小行星 | A.真 | 矩形 | 深绿 `#2E7D32` | 2px | `★` 符号 | 小行星/彗星 |
| 标注框-超新星 | A.真 | 矩形 | 鲜绿 `#00E676` | 2px | `💥` 符号 | 暂现源新星 |
| 标注框-变星 | A.真 | 矩形 | 浅绿 `#69F0AE` | 2px | `✦` 符号 | 周期/非周期变星 |
| 标注框-卫星线 | B.假 | 矩形 | 深红 `#C62828` | 2px | `🛰️` 符号 | 人造卫星轨迹 |
| 标注框-噪点 | B.假 | 矩形 | 橙红 `#EF5350` | 2px | `⚡` 符号 | 图像噪点/热点 |
| 标注框-星芒 | B.假 | 矩形 | 橙色 `#FF9800` | 2px | `✨` 符号 | 衍射芒 |
| 标注框-CMOS结霜 | B.假 | 矩形 | 灰橙 `#FFB74D` | 2px | `❄️` 符号 | 传感器结霜 |
| 标注框-有对应 | B.假 | 矩形 | 灰色 `#BDBDBD` | 2px | `🔀` 符号 | 新旧图均有 |
| 标注框-未标注 | — | 矩形 | 黄色 `#FFEB3B` | 2px | `?` | 未赋标签 |
| 标注框-选中 | — | 矩形 + 缩放手柄 | 紫色 `#9C27B0` | 3px | — | 加粗 + 八向手柄 |
| 标注框-AI预标注 | — | 虚线矩形 | 青色 `#00BCD4` | 1px | `AI` + 置信度 | AI建议，待确认 |

**颜色编码规则**:
- **A. 真类**: 绿色系 (`#2E7D32` / `#00E676` / `#69F0AE`) — 根据子类型区分深浅
- **B. 假类**: 红色/橙色/灰色系 — 卫星线=深红，噪点=橙红，星芒=橙，CMOS=灰橙，有对应=中性灰
- **未标注**: 黄色高亮提示
- **AI 预标注**: 青色虚线 + `AI` 前缀 + 置信度数值

### 11.3 字体

| 用途 | 字体 | 大小 | 权重 |
|------|------|------|------|
| 界面文字 | 系统默认 / Microsoft YaHei | 12px | Regular |
| 候选编号 | Arial | 10px | Bold |
| 状态浮层 | Arial | 14px | Bold |
| MPC 报告 | Consolas / 等宽 | 12px | Regular |
| 坐标显示 | Consolas / 等宽 | 11px | Regular |

### 11.4 间距与尺寸

| 元素 | 值 |
|------|-----|
| 窗口内边距 | 4px |
| 面板内边距 | 2px |
| 按钮间距 | 4px |
| 按钮最小高度 | 28px |
| 侧边栏默认宽度 | 240px |
| 侧边栏最小宽度 | 200px |
| 控制栏高度 | 40px |
| 状态栏高度 | 24px |
| 标记圆圈半径 | 15px |

---

## 12. 可访问性与响应式

### 12.1 窗口缩放

| 分辨率 | 侧边栏 | 图像区域 | 控制栏 |
|--------|--------|----------|--------|
| 1920×1080 (FHD) | 240px | 1680px | 全宽 |
| 2560×1440 (QHD) | 280px | 2280px | 全宽 |
| 3840×2160 (4K) | 320px | 3520px | 全宽 |
| 1366×768 (笔记本) | 200px / 隐藏 | 1166px+ | 全宽 |

### 12.2 最小窗口尺寸

- **最小宽度**: 1024px
- **最小高度**: 768px
- 当窗口宽度 < 1200px 时，侧边栏自动折叠

### 12.3 高 DPI 支持

- 使用 `QApplication.setAttribute(Qt.AA_EnableHighDpiScaling)` 启用 HiDPI
- 图标使用 SVG 或 Emoji (无位图图标依赖)
- 标记线宽随 DPI 缩放

---

## 13. 需求追溯矩阵

| 需求编号 | 需求描述 | UI/UX 设计对应 | 章节 |
|----------|----------|---------------|------|
| R-01 | 按照新旧文件夹加载 FITS | 侧边栏: 新/旧图文件夹按钮 | §5.1, §4.2 |
| R-02 | 两个按钮显示新旧图 | 控制栏: [新图] [旧图] 按钮 | §5.2 |
| R-03 | 读取 FITS 文件头 | 状态栏坐标显示 + FITS头信息面板 | §4.1 |
| R-04 | 批量对齐 (新图为参考) | 侧边栏: [批量对齐] 按钮 + 进度条 | §4.2 |
| R-05 | 闪烁功能 + 可选速度 | 控制栏: 闪烁按钮 + 速度滑块 | §5.2 |
| R-06 | 直方图/屏幕拉伸 (不改原始数据) | 直方图拉伸面板 (§5.3) | §5.3 |
| R-07 | 反色 (持久状态) | 控制栏: 反色按钮 (toggle) + 状态浮层 | §5.2, §7.3 |
| R-08 | 可选批量降噪/伪平场 (另存为) | 批量处理对话框 (§5.7) | §5.7 |
| R-09 | AI 手动标记真假目标 | 控制栏: [真Y] [假N] + 快捷键 | §5.2, §8.1 |
| R-10 | 目标标记方框/十字线 | 图像查看器: 标记绘制系统 | §10.2 |
| R-11 | 标记另存为 (带拍摄日期) | 文件菜单: 另存为标记图 | §5.7 |
| R-12 | AI 全图检测 | 侧边栏: [批量检测] + 可疑目标列表 | §5.1, §5.4 |
| R-13 | 显存 ≤ 8GB + CUDA | 设置: 显存限制 (后端约束) | §5.5 |
| R-14 | MPCORB 叠加显示 | 图像查看器: 已知小行星叠加层 | §5.1, §10.2 |
| R-15 | 极限星等过滤 | 设置: 极限星等参数 | §5.5 |
| R-16 | 望远镜/天文台参数设置 | 设置对话框: 望远镜/天文台标签页 | §5.5 |
| R-17 | 已知排除 (MPCORB + 查询) | 可疑目标列表: 灰色已知 + 筛选 | §5.4 |
| R-18 | 右键查询 VSX/MPC/SIMBAD/TNS | 右键上下文菜单 | §5.9 |
| R-19 | MPC 80 列报告 | MPC 报告预览窗 | §5.8 |
| R-20 | 保存为整数 (16/32bit) | 批量处理: 位深度选项 | §5.7 |
| R-21 | 不修改 FITS 头 | 全局约束 (UI 显示提醒) | §5.7 |
| R-22 | 界面紧凑 | 全局布局: 最小边距/间距 | §4.3, §10.4 |
| R-23 | 可疑目标列表 (AI评分+坐标) | 可疑目标表格 Widget | §5.4 |
| R-24 | 中键拖拽 (新旧图同步) | 图像查看器: 中键事件 | §7.1, §7.2 |
| R-25 | 快捷键 r/n/y/滚轮/i | 快捷键体系 | §8.1 |
| R-26 | 所有 SpinBox 禁用滚轮 | NoScrollSpinBox 组件 | §6.1 |
| R-27 | 快捷键非全局 (窗口焦点) | `Qt.WindowShortcut` | §8.3 |
| R-28 | 定时爬 HMT (可选) | 设置: 计划任务配置 | §5.5 |
| R-29 | GUI 标注工具 (v1 三联图分类) | 标注对话框: v1 模式 | §6.2.1 |
| R-30 | GUI 标注工具 (v2 FITS 全图检测) | 标注对话框: v2 模式 | §6.2.2 |
| R-31 | 标注后端抽象 (双格式兼容) | AnnotationBackend 策略模式 | §6.1 |
| R-32 | AI 预标注支持 | AI 批量预标注对话框 | §6.3 |
| R-33 | 标注数据集导出 (多格式) | 导出对话框 | §6.4 |
| R-34 | 单样本标注效率 ≤ 2s | 快捷键 + 自动跳转 | §6.5, §8.5 |
| R-35 | 标注撤销/重做 | Undo/Redo 操作栈 | §6.1.1 |

---

## 附录 A: 菜单栏完整结构

```
文件 (F)
├── 打开新图文件夹        Ctrl+O
├── 打开旧图文件夹        Ctrl+Shift+O
├── ────────────
├── 保存当前图像          Ctrl+S
├── 另存为标记图...       Ctrl+Shift+S
├── ────────────
├── 最近打开 ►
└── 退出                  Alt+F4

处理 (P)
├── 批量对齐
├── ────────────
├── 批量降噪/伪平场...
├── ────────────
└── 直方图拉伸            (面板切换)

AI (A)
├── 批量检测              F5
├── ────────────
├── 标注工具...          Ctrl+L
├── ────────────
├── 训练模型...
├── 加载模型...
└── 模型信息

查询 (Q)
├── 查询 VSX
├── 查询 MPC
├── 查询 SIMBAD
├── 查询 TNS
├── 人造卫星查询
├── ────────────
└── 生成 MPC 80列报告     Ctrl+E

视图 (V)
├── 切换侧边栏            Ctrl+B
├── ────────────
├── 适配窗口              F
├── 实际大小              Ctrl+0
├── 放大                  Ctrl++
├── 缩小                  Ctrl+-
├── ────────────
├── 显示候选标记          ☑
├── 显示 MPCORB 叠加     ☑
└── 显示已知天体          ☑

设置 (S)
├── 首选项...             Ctrl+,
├── ────────────
├── MPCORB 文件...
└── 计划任务...

帮助 (H)
├── 快捷键列表
├── 使用文档
├── ────────────
└── 关于 SCANN v2
```

---

## 附录 B: Widget 层级树

```
QMainWindow (MainWindow)
├── QMenuBar
├── QWidget (centralWidget)
│   └── QHBoxLayout
│       └── QSplitter (horizontal)
│           ├── CollapsibleSidebar (240px)
│           │   ├── QPushButton × 2 (新/旧文件夹)
│           │   ├── QPushButton × 2 (对齐/检测)
│           │   ├── QProgressBar
│           │   ├── QListWidget (图像配对列表)
│           │   └── SuspectTableWidget (可疑目标)
│           │       └── CoordinateLabel
│           └── QWidget (rightPanel)
│               └── QVBoxLayout
│                   ├── OverlayLabel (NEW/OLD 状态)
│                   ├── FitsImageViewer (弹性, stretch=1)
│                   │   └── QGraphicsScene
│                   │       ├── QGraphicsPixmapItem (图像)
│                   │       ├── QGraphicsEllipseItem[] (候选标记)
│                   │       └── MpcorbOverlay (叠加层)
│                   └── QHBoxLayout (controlBar, 40px)
│                       ├── QPushButton (新图/旧图/闪烁/反色)
│                       ├── BlinkSpeedSlider
│                       ├── QSpacerItem (弹性)
│                       └── QPushButton (真/假/下一个)
└── QStatusBar
    ├── QLabel (当前图: NEW/OLD)
    ├── CoordinateLabel (像素坐标)
    ├── CoordinateLabel (天球坐标)
    └── QLabel (缩放百分比)

AnnotationDialog (非模态, 独立窗口)
├── QComboBox (模式选择: v1三联图 / v2 FITS全图)
├── QHBoxLayout (数据集路径 + 浏览按钮)
├── QSplitter (horizontal)
│   ├── QWidget (viewerPanel)
│   │   ├── TripletPreviewPanel (v1模式, 3×80×80 放大)
│   │   │   └── QLabel × 3 (差异图/新图/参考图)
│   │   ├── AnnotationViewer (v2模式, QGraphicsView)
│   │   │   └── QGraphicsScene
│   │   │       ├── QGraphicsPixmapItem (FITS图像)
│   │   │       └── QGraphicsRectItem[] (标注框)
│   │   └── DrawToolBar (v2模式, 框选/点标/移动/缩放)
│   └── QWidget (sidePanel)
│       ├── AnnotationListWidget (v2模式, 标注框列表)
│       └── AnnotationStatsPanel (通用, 进度+统计)
├── QVBoxLayout (v1模式快速标签面板)
│   ├── QLabel (A.真)
│   ├── QPushButton × 3 (小行星Y1 / 超新星Y2 / 变星Y3)
│   ├── QLabel (B.假)
│   ├── QPushButton × 5 (卫星线N1 / 噪点N2 / 星芒N3 / CMOS N4 / 有对应N5)
├── QHBoxLayout (操作栏)
│   ├── QPushButton (⏭跳过 S)
│   ├── QPushButton (◀上一个Z / ▶下一个Space)
│   ├── QPushButton (↩撤销 / ↪重做)
│   └── QCheckBox (自动下一个 / AI预标注)
├── QHBoxLayout (筛选栏)
│   ├── QRadioButton × 4 (全部/未标注/A.真/B.假)
│   └── QComboBox (排序方式)
└── QHBoxLayout (底栏)
    ├── QPushButton (导出数据集 / 批量AI预标注)
    └── QPushButton (关闭)
```

---

## 附录 C: 对话框/浮窗清单

| 名称 | 类型 | 触发 | 模态 |
|------|------|------|------|
| SettingsDialog | QDialog | 菜单/Ctrl+, | 模态 |
| TrainingDialog | QDialog | 菜单 AI > 训练 | 非模态 |
| **AnnotationDialog** | **QDialog** | **菜单 AI > 标注 / Ctrl+L** | **非模态** |
| BatchProcessDialog | QDialog | 菜单 处理 > 批量 | 模态 |
| MpcReportDialog | QDialog | 右键 > MPC 报告 | 非模态 |
| QueryResultPopup | QFrame (浮窗) | 右键查询返回 | 非模态 |
| HistogramPanel | QDockWidget | 菜单/按钮 | 非模态/可停靠 |
| ShortcutHelpDialog | QDialog | 菜单 帮助 | 非模态 |

---

## 附录 D: 信号-槽连接概览

```
文件夹按钮.clicked  ────→  FileManager.scan_fits_folder()
                           ↓
                    file_list 更新
                           ↓
file_list.currentRowChanged ──→ 加载图像配对 → ImageViewer.set_image_data()

btn_blink.clicked  ────→  BlinkService.toggle() ──→ QTimer start/stop
QTimer.timeout     ────→  BlinkService.tick()   ──→ 切换 NEW/OLD 显示

btn_detect.clicked ────→  DetectionPipeline.process_pair()
                          ↓ (工作线程)
                    完成信号 → SuspectTableWidget 更新

suspect_list.clicked ──→  ImageViewer.centerOn(candidate)
                         ImageViewer.draw_markers(selected=idx)

ImageViewer.right_click ──→ QMenu.exec() ──→ QueryService.query_xxx()
                                              ↓
                                        QueryResultPopup 显示

btn_mark_real.clicked ──→ candidate.verdict = REAL
                         SuspectTableWidget 刷新行状态

# 标注工具信号流 (AnnotationDialog)
mode_selector.changed   ───→  切换 AnnotationBackend (v1/v2)
                               UI 自适应布局切换

btn_load_dataset.clicked ──→  backend.load_samples()
                               → 图像加载 + 统计更新

# v1 模式: 子类型标注
btn_mark_Y1-Y3.clicked / key_Y1-Y3  ─→ backend.save_annotation("real", detail_type="asteroid|supernova|variable_star")
                                       → stats_panel 更新 (细分类型统计)
                                       → auto_advance → 加载下一样本

btn_mark_N1-N5.clicked / key_N1-N5  ─→ backend.save_annotation("bogus", detail_type="satellite_trail|noise|diffraction_spike|cmos_condensation|corresponding")
                                       → stats_panel 更新 (细分类型统计)
                                       → auto_advance → 加载下一样本

# v2 模式: 边界框 + 子类型
AnnotationViewer.box_drawn  ───→  弹出标签选择对话框 → 用户选择子类型 (Y1-Y3/N1-N5)
                                  → backend.save_bbox(bbox, label="real|bogus", detail_type="...")
                                  → AnnotationListWidget 更新

AnnotationViewer.box_selected  ─→  显示框属性面板 (位置/大小/子类型/置信度)
                                  → 支持编辑子类型 (Y1-Y3/N1-N5)

# v2 新旧图切换
btn_toggle_new_old.clicked / key_Tab_1_2_F5  ─→  切换显示图像 (NEW ↔ OLD)
                                                → 标注框同步显示 (像素坐标不变)
                               → stats_panel 更新
                               → auto_advance → 加载下一样本

annotation_viewer.bbox_drawn → backend.save_annotation(bbox)
                               → annotation_list 更新

btn_ai_prelabel.clicked ───→ 工作线程: InferenceEngine
                               → 完成信号 → 更新 AI 建议

btn_export.clicked ──────→  ExportDialog → backend.export_dataset()
```

---

*文档结束。本设计遵循需求文档和架构设计中的所有约束，每项需求均可在追溯矩阵 (§13) 中找到对应设计。v1.1 新增 §6 标注工具系统设计，支持 v1/v2 双模式标注。*
