# SCANN v2 UI/UX 设计文档

> **版本**: 1.0  
> **日期**: 2026-02-08  
> **框架**: PyQt5  
> **输入**: [需求文档](../../new%20requirements.md) · [架构设计](architecture.md)

---

## 目录

1. [设计目标与原则](#1-设计目标与原则)
2. [用户角色与使用场景](#2-用户角色与使用场景)
3. [信息架构](#3-信息架构)
4. [全局布局](#4-全局布局)
5. [页面/视图详细设计](#5-页面视图详细设计)
6. [组件库规范](#6-组件库规范)
7. [交互规范](#7-交互规范)
8. [快捷键体系](#8-快捷键体系)
9. [状态机与工作流](#9-状态机与工作流)
10. [视觉规范](#10-视觉规范)
11. [可访问性与响应式](#11-可访问性与响应式)
12. [需求追溯矩阵](#12-需求追溯矩阵)

---

## 1. 设计目标与原则

### 1.1 设计目标

| # | 目标 | 度量标准 |
|---|------|----------|
| G1 | **最大化图像展示** | 图像区域占窗口面积 ≥ 75% |
| G2 | **高效闪烁比对** | 新旧图切换延迟 < 16ms (60fps) |
| G3 | **零学习成本快捷键** | 核心操作单键触达，无需组合键 |
| G4 | **天文工作流无中断** | 从加载到输出报告全程不切换窗口 |
| G5 | **FITS 数据完整性** | 任何保存操作不丢失/修改 FITS 头信息 |

### 1.2 设计原则

1. **图像为王 (Image-First)**  
   所有控件为图像让路。侧边栏可折叠，工具栏紧贴边缘，状态信息浮层显示。

2. **渐进式披露 (Progressive Disclosure)**  
   首屏仅展示核心功能 (打开/闪烁/标记)；高级功能 (AI训练/计划任务/降噪) 通过菜单或设置面板按需展开。

3. **模态最小化 (Minimal Modality)**  
   除文件选择器和设置对话框外，所有操作在主窗口完成，不弹出模态窗口阻断工作流。

4. **状态可见性 (Status Visibility)**  
   当前显示的是新图/旧图、反色状态、闪烁状态、AI 进度，均在 UI 上有明确视觉反馈。

5. **容错与可逆 (Forgiving & Reversible)**  
   标记真/假可随时修改；处理操作仅影响显示，不修改原始 FITS 数据。

---

## 2. 用户角色与使用场景

### 2.1 用户画像

| 角色 | 描述 | 核心需求 |
|------|------|----------|
| **巡天猎手** | 业余天文爱好者，通过闪烁法寻找新天体 | 快速加载、高效闪烁比对、AI 辅助检测 |
| **跟踪观测者** | 对已发现目标进行跟踪观测并上报 MPC | 精确坐标、MPC 80 列报告生成 |
| **AI 训练员** | 标注训练数据、训练/评估模型 | 批量标记界面、训练进度监控 |

### 2.2 核心使用场景 (Use Cases)

```
UC-01  加载新旧文件夹 → 自动配对 → 浏览图像列表
UC-02  闪烁比对 → 发现可疑目标 → 标记真/假
UC-03  AI 批量检测 → 按置信度排序 → 人工复核
UC-04  右键查询外部数据库 → 排除已知天体
UC-05  生成 MPC 80列报告 → 复制/导出
UC-06  设置望远镜参数 → MPCORB 叠加显示
UC-07  批量降噪/伪平场 → 另存为 FITS
UC-08  标记训练样本 → 训练 AI 模型
```

---

## 3. 信息架构

```
SCANN v2
├── 📂 文件管理
│   ├── 新图文件夹
│   ├── 旧图文件夹
│   └── 保存文件夹
├── 🔭 图像浏览
│   ├── 图像配对列表
│   ├── 图像查看器 (新图/旧图切换)
│   ├── 闪烁控制
│   └── 直方图/显示调整
├── ⚡ 检测与分析
│   ├── 批量对齐
│   ├── AI 检测
│   ├── 可疑目标列表
│   └── 已知排除
├── 🌐 外部查询
│   ├── VSX / MPC / SIMBAD / TNS
│   ├── 人造卫星查询
│   └── MPC 80列报告
├── 🧠 AI 训练
│   ├── 标记管理
│   ├── 训练配置
│   └── 训练监控
├── 🪐 MPCORB 叠加
│   ├── MPCORB 文件管理
│   └── 极限星等过滤
└── ⚙️ 设置
    ├── 望远镜/相机参数
    ├── 天文台信息
    ├── 检测参数
    ├── AI 参数
    └── 保存选项
```

---

## 4. 全局布局

### 4.1 主窗口线框图 (ASCII Wireframe)

```
┌─────────────────────────────────────────────────────────────────────────┐
│ 📋 菜单栏: 文件 | 处理 | AI | 查询 | 视图 | 设置 | 帮助              │
├────────┬────────────────────────────────────────────────────────────────┤
│        │  ┌─[新图 ▸]─[旧图 ▸]─────── 文件名: NGC1234_20260208.fits ┐  │
│  侧    │  │                                                         │  │
│  边    │  │                                                         │  │
│  栏    │  │                                                         │  │
│        │  │               图 像 查 看 器                            │  │
│  (可   │  │          (占据最大可用空间)                              │  │
│  折    │  │                                                         │  │
│  叠)   │  │     ○ 候选体标记 (方框/十字线)                          │  │
│        │  │     ★ MPCORB 已知小行星叠加                             │  │
│  240px │  │                                                         │  │
│        │  └─────────────────────────────────────────────────────────┘  │
│        │  ┌ 控制栏 ────────────────────────────────────────────────┐  │
│        │  │ [新图] [旧图] [✨闪烁] ●500ms  [🔄反色] [📊拉伸]     │  │
│        │  │                        ──────  [✅真Y] [❌假N] [➡下一] │  │
│        │  └────────────────────────────────────────────────────────┘  │
├────────┴────────────────────────────────────────────────────────────────┤
│ 状态栏: 新图/旧图 | 坐标 X:1024 Y:768 | RA:12h34m Dec:+56°78' | 缩放 │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.2 侧边栏布局 (可折叠)

```
┌────────────────────┐
│ 📂 文件夹         │
│ [新图文件夹] [旧图]│
│ [🔗对齐] [⚡检测]  │
├────────────────────┤
│ 📁 图像配对 (3/15) │
│ ┌────────────────┐ │
│ │● NGC1234_001   │ │
│ │  NGC1234_002   │ │
│ │  NGC1234_003   │ │
│ │  ...           │ │
│ └────────────────┘ │
├────────────────────┤
│ 🔥 可疑目标 (5)    │
│ ┌────────────────┐ │
│ │ #1 ⭐0.97      │ │
│ │  (1024, 768)   │ │
│ │ #2 ⭐0.89      │ │
│ │  (512, 400)    │ │
│ │ #3 ⭐0.73      │ │
│ │  ...           │ │
│ └────────────────┘ │
│ [复制坐标] [导出]  │
└────────────────────┘
```

### 4.3 布局分配规则

| 区域 | 最小宽度 | 策略 | 说明 |
|------|----------|------|------|
| 侧边栏 | 200px | 固定/可折叠 | `Ctrl+B` 切换显示，折叠后图像区域100% |
| 图像查看器 | 自适应 | 弹性填充 | 始终获取剩余所有空间 |
| 控制栏 | 全宽 | 固定高度 40px | 核心操作按钮 + 闪烁速度 |
| 菜单栏 | 全宽 | 固定高度 | 高级功能入口 |
| 状态栏 | 全宽 | 固定高度 24px | 实时坐标/状态信息 |

---

## 5. 页面/视图详细设计

### 5.1 主视图 — 图像浏览与闪烁

**入口**: 应用启动默认视图

**区域拆分**:

```
 ┌──────────────────────────────────────────────────┐
 │                 ImageViewerWidget                 │
 │                                                   │
 │  ┌─ OverlayHUD (浮层) ─────────────────────────┐ │
 │  │ 左上: [NEW] / [OLD] 状态标签 (半透明)       │ │
 │  │ 右上: 缩放百分比                             │ │
 │  │ 右下: 反色/闪烁状态图标                      │ │
 │  └─────────────────────────────────────────────┘ │
 │                                                   │
 │  图像内容 (QGraphicsView)                         │
 │  - 候选体方框标记 (绿色=自动, 紫色=手动)         │
 │  - 选中候选体标记 (红色加粗)                      │
 │  - MPCORB已知小行星 (灰色虚线圆 + 名称标签)      │
 │                                                   │
 └──────────────────────────────────────────────────┘
```

**状态标签设计**:

| 状态 | 标签文本 | 背景色 | 位置 |
|------|----------|--------|------|
| 显示新图 | `NEW` | `#2196F3` (蓝) 半透明 | 左上角 |
| 显示旧图 | `OLD` | `#FF9800` (橙) 半透明 | 左上角 |
| 反色开启 | `INV` 图标 | `#9C27B0` (紫) | 右下角 |
| 闪烁中 | `⚡` 脉冲动画 | — | 右下角 |

**闪烁行为规范**:
- 默认速度 500ms，可在控制栏 `NoScrollSpinBox` 中调整 (50ms ~ 2000ms)
- 闪烁期间新旧图共享同一视口变换 (缩放/平移同步)
- 反色状态在闪烁切换时保持，直到用户再次按 `I`
- 切换图像配对时，闪烁自动停止

### 5.2 控制栏详细设计

```
┌─────────────────────────────────────────────────────────────────────┐
│ [1:新图]  [2:旧图]  │ [✨闪烁R]  ●━━━━━○ 500ms  │ [🔄反色I]     │
│                      │  (toggle)   (slider)        │  (toggle)     │
│ [📊直方图拉伸]       │                              │               │
│                      ├──────────────────────────────┤               │
│                      │           弹性空间            │               │
│                      ├──────────────────────────────┤               │
│                      │ [✅真 Y]  [❌假 N]  [➡下一]  │               │
└─────────────────────────────────────────────────────────────────────┘
```

**按钮状态矩阵**:

| 按钮 | 默认态 | 激活态 | 禁用态 |
|------|--------|--------|--------|
| 新图 | 灰底黑字 | 蓝底白字 (当前显示新图) | 灰底灰字 (未加载) |
| 旧图 | 灰底黑字 | 橙底白字 (当前显示旧图) | 灰底灰字 (未加载) |
| 闪烁 | 灰底 | 黄底 + 脉冲边框 | 灰底 (未加载) |
| 反色 | 灰底 | 紫底白字 | — |
| 标记真 | `#4CAF50` 绿底白字 | 按下凹陷 | 灰底 (无候选) |
| 标记假 | `#F44336` 红底白字 | 按下凹陷 | 灰底 (无候选) |

### 5.3 直方图拉伸面板

**触发**: 点击 `📊直方图拉伸` 按钮或菜单 `视图 > 直方图拉伸`

```
┌─ 直方图拉伸 (仅显示，不改变原始数据) ───────────────┐
│                                                       │
│  ▁▂▃▅▇█▇▅▃▂▁▁▁▁▁  (实时直方图)                      │
│  ▲                ▲                                   │
│  Black Point       White Point                        │
│                                                       │
│  黑点: [====●===========] 500    ← NoScrollSpinBox    │
│  白点: [==============●=] 60000  ← NoScrollSpinBox    │
│                                                       │
│  预设: [线性▾] [对数] [平方根] [Asinh] [自动拉伸]     │
│                                                       │
│  [重置]                            [应用到所有配对]    │
└───────────────────────────────────────────────────────┘
```

**约束**: 
- 仅临时调整显示亮度，**不改变图片原有实际像素**，**不保存**
- 拉伸参数在闪烁新旧图时同步应用
- 切换图像配对时可选择是否保留拉伸参数

### 5.4 可疑目标列表 (Suspect List Widget)

```
┌─ 🔥 可疑目标 (AI排序) ─────── [导出CSV] ───────────┐
│ ┌───┬─────────┬──────────────┬───────────┬────────┐ │
│ │ # │ AI 评分 │ 像素坐标      │ WCS 坐标  │ 判决   │ │
│ ├───┼─────────┼──────────────┼───────────┼────────┤ │
│ │ 1 │ ⭐ 0.97 │ (1024, 768)  │ 12h34m... │ ──     │ │
│ │ 2 │ ⭐ 0.89 │ (512, 400)   │ 05h12m... │ ✅ 真  │ │
│ │ 3 │ ⭐ 0.73 │ (200, 150)   │ 19h45m... │ ❌ 假  │ │
│ │ 4 │ ⭐ 0.65 │ (800, 600)   │ 08h22m... │ 🔘 已知│ │
│ └───┴─────────┴──────────────┴───────────┴────────┘ │
│                                                       │
│ 📋 坐标: RA 12h34m56.7s  Dec +56°78'90"  [复制]     │
│                                                       │
│ 右键菜单:                                             │
│   查询 VSX  |  查询 MPC  |  查询 SIMBAD              │
│   查询 TNS  |  人造卫星  |  生成 MPC 报告            │
└───────────────────────────────────────────────────────┘
```

**交互规则**:
- 单击选中 → 图像查看器自动居中到该候选体
- 双击 → 放大到候选体周围 200×200 像素区域
- 右键 → 弹出外部查询菜单
- `Y` / `N` → 标记当前选中候选
- 坐标文字可鼠标选中复制 (使用 `CoordinateLabel`)
- 已知天体行以灰色显示，可通过筛选器隐藏

### 5.5 设置对话框 (Settings Dialog)

**触发**: 菜单 `设置 > 首选项` 或 `Ctrl+,`

采用分页标签式布局:

```
┌─ 设置 ──────────────────────────────────────────────┐
│ [望远镜/相机] [天文台] [检测参数] [AI] [保存] [高级] │
├─────────────────────────────────────────────────────┤
│                                                      │
│  === 望远镜/相机参数 ===                             │
│                                                      │
│  像素大小:      [  9.0  ] μm    ← NoScrollSpinBox   │
│  像素分辨率:    [  1.23 ] ″/pix (自动计算/可覆盖)   │
│  焦距:          [ 1500  ] mm    ← NoScrollSpinBox   │
│  相机旋转角:    [  0.0  ] °     ← NoScrollSpinBox   │
│                                                      │
│  ─────────────────────────────────────               │
│                                                      │
│  === 文件夹路径 ===                                  │
│                                                      │
│  新图文件夹: [________________________] [浏览...]     │
│  旧图文件夹: [________________________] [浏览...]     │
│  保存文件夹: [________________________] [浏览...]     │
│                                                      │
│              [恢复默认]          [确定] [取消]        │
└──────────────────────────────────────────────────────┘
```

**全部 SpinBox 使用 `NoScrollSpinBox` / `NoScrollDoubleSpinBox`，禁用滚轮。**

#### 5.5.1 设置页面分页内容

| 页签 | 字段 |
|------|------|
| **望远镜/相机** | 像素大小(μm), 像素分辨率(″/pix), 焦距(mm), 相机旋转角(°) |
| **天文台** | MPC代码, 名称, 经度(°), 纬度(°), 海拔(m) |
| **检测参数** | 阈值, 最小面积, 锐度范围, 对比度, 边缘裁剪, 动态阈值, 过滤器开关 |
| **AI** | 模型路径, 拥挤场评分/计数/惩罚, 显存限制 |
| **保存** | 位深度(16/32bit), MPCORB路径, 极限星等 |
| **高级** | 闪烁速度, 计划任务配置, HMT 目录地址 |

### 5.6 AI 训练对话框 (Training Dialog)

**触发**: 菜单 `AI > 训练模型`

```
┌─ AI 模型训练 ───────────────────────────────────────┐
│                                                      │
│  === 训练数据集 ===                                  │
│  正样本文件夹: [____________________] [浏览]   (32)  │
│  负样本文件夹: [____________________] [浏览]  (128)  │
│  验证集比例:   [ 0.2 ] ← NoScrollSpinBox            │
│                                                      │
│  === 训练参数 ===                                    │
│  Epochs:       [  50 ]     Batch Size: [  16 ]       │
│  学习率:       [0.001]     Early Stop: [  10 ]       │
│  模型输出:     [____________________] [浏览]         │
│                                                      │
│  === 训练进度 ===                                    │
│  Epoch: 23/50  ████████████░░░░░░░░  46%             │
│  Loss: 0.0342  Val Acc: 94.2%                        │
│  ┌─────────────────────────────────────────────┐     │
│  │  Loss/Accuracy 实时曲线图                    │     │
│  │                                              │     │
│  └─────────────────────────────────────────────┘     │
│                                                      │
│  [开始训练]  [暂停]  [停止]           [关闭]         │
└──────────────────────────────────────────────────────┘
```

### 5.7 批量处理对话框

**触发**: 菜单 `处理 > 批量降噪/伪平场`

```
┌─ 批量图像处理 ──────────────────────────────────────┐
│                                                      │
│  处理选项:                                           │
│  ☑ 降噪     方法: [中值滤波 ▾]                      │
│  ☑ 伪平场   核大小: [ 64 ] px                        │
│                                                      │
│  输入: 已加载的新旧图文件夹 (15 对)                  │
│  输出: [________________________] [浏览...]           │
│                                                      │
│  保存选项:                                           │
│  位深度: ○ 16-bit  ● 32-bit                          │
│  ⚠ 原始 FITS 头将完整保留                            │
│                                                      │
│  进度: ████████░░░░░░░░  8/15                        │
│                                                      │
│  [开始处理]  [取消]                                  │
└──────────────────────────────────────────────────────┘
```

### 5.8 MPC 报告预览

**触发**: 可疑目标右键菜单 `生成 MPC 报告`

```
┌─ MPC 80列观测报告 ──────────────────────────────────┐
│                                                      │
│  ┌──────────────────────────────────────────────┐    │
│  │ COD XXX                                       │    │
│  │ OBS [观测者姓名]                              │    │
│  │ MEA [测量者姓名]                              │    │
│  │ TEL [望远镜描述]                              │    │
│  │ NET UCAC4                                     │    │
│  │      K26B08  12 34 56.78 +56 78 90.1  20.1V │    │
│  │ ----- end -----                               │    │
│  └──────────────────────────────────────────────┘    │
│                                                      │
│  [复制到剪贴板]  [保存为 .txt]           [关闭]      │
└──────────────────────────────────────────────────────┘
```

### 5.9 右键上下文菜单

**触发**: 在图像查看器中右键点击

```
┌─────────────────────────┐
│ 🔍 查询 VSX             │
│ 🔍 查询 MPC             │
│ 🔍 查询 SIMBAD          │
│ 🔍 查询 TNS             │
│ 🛰️ 查询人造卫星         │
│ ─────────────────────── │
│ 📝 生成 MPC 80列报告    │
│ ─────────────────────── │
│ ➕ 手动添加候选体        │
│ 🏷️ 标记为真 (Y)         │
│ 🏷️ 标记为假 (N)         │
│ ─────────────────────── │
│ 📋 复制像素坐标          │
│ 📋 复制天球坐标          │
└─────────────────────────┘
```

---

## 6. 组件库规范

### 6.1 自定义 Widget 清单

| 组件 | 类名 | 文件 | 说明 |
|------|------|------|------|
| FITS图像查看器 | `FitsImageViewer` | `image_viewer.py` | QGraphicsView 子类，支持中键拖拽/滚轮缩放/标记绘制 |
| 可复制坐标标签 | `CoordinateLabel` | `widgets/coordinate_label.py` | 可选中复制文本的 QLabel |
| 无滚轮SpinBox | `NoScrollSpinBox` | `widgets/no_scroll_spinbox.py` | 屏蔽 wheelEvent |
| 无滚轮DoubleSpinBox | `NoScrollDoubleSpinBox` | `widgets/no_scroll_spinbox.py` | 屏蔽 wheelEvent |
| 浮层状态标签 | `OverlayLabel` | `widgets/overlay_label.py` | **新增** 半透明浮层，显示 NEW/OLD/INV 状态 |
| 可疑目标表格 | `SuspectTableWidget` | `widgets/suspect_table.py` | **新增** 带排序/筛选/右键菜单的目标列表 |
| 直方图面板 | `HistogramPanel` | `widgets/histogram_panel.py` | **新增** 实时直方图 + 黑白点滑块 |
| 闪烁速度滑块 | `BlinkSpeedSlider` | `widgets/blink_speed_slider.py` | **新增** 带数值显示的速度控制 |
| 可折叠侧边栏 | `CollapsibleSidebar` | `widgets/collapsible_sidebar.py` | **新增** 可折叠/展开的侧面板 |
| MPCORB叠加层 | `MpcorbOverlay` | `widgets/mpcorb_overlay.py` | **新增** 在图像上绘制已知小行星位置 |

### 6.2 组件状态设计

#### FitsImageViewer 状态图

```
                    ┌───────────┐
                    │   Empty   │  ← 初始状态
                    └─────┬─────┘
                          │ load_image()
                    ┌─────▼─────┐
              ┌────►│ Viewing   │◄────┐
              │     └──┬──┬──┬──┘     │
              │        │  │  │        │
    show_new()│  blink │  │  │ zoom() │ pan()
              │        │  │  │        │
              │     ┌──▼──┘  └──▼──┐  │
              │     │Blinking│  │Zoom│──┘
              │     └──┬─────┘  └───┘
              │        │ stop_blink()
              └────────┘
```

---

## 7. 交互规范

### 7.1 鼠标交互

| 操作 | 区域 | 行为 | 说明 |
|------|------|------|------|
| **左键单击** | 图像 | 选中最近的候选体 / 获取坐标 | 状态栏更新坐标 |
| **左键双击** | 候选列表 | 图像居中并放大到候选体 | 200×200px 视口 |
| **中键按住拖拽** | 图像 | 平移图像 | 新旧图同步平移 |
| **右键单击** | 图像 | 弹出上下文查询菜单 | 见 §5.9 |
| **滚轮** | 图像 | 缩放 (以鼠标位置为锚点) | 缩放因子 1.25x |
| **滚轮** | SpinBox | **无效** (已禁用) | 防止误操作 |

### 7.2 拖拽同步规范

闪烁期间平移/缩放操作必须对新旧图同步生效:

```
用户中键拖拽 → ImageViewer 记录 viewport transform
             → BlinkService.tick() 切换图像
             → 新图像应用相同 viewport transform
             → 视觉上: 内容切换，位置不变
```

**实现要求**: `FitsImageViewer` 内部仅维护一个 viewport 变换矩阵，切换新旧图时仅替换像素数据，不重置变换。

### 7.3 反色交互规范

```
用户按 I → toggle_invert() → 反色状态翻转
         → 当前显示图像立即刷新为反色/正常
         → 后续切换图像/闪烁时，沿用当前反色状态
         → 切换到下一组图像配对时，反色状态保持
         → 再次按 I 才关闭反色
```

### 7.4 外部查询交互流程

```
右键点击图像某点
  ↓
弹出上下文菜单 (§5.9)
  ↓
用户选择 "查询 MPC"
  ↓
后台线程发起 HTTP 查询
  ↓                       ↓
成功: 弹出结果浮窗       失败: 状态栏提示 "查询超时"
  ↓
"MPC 查询结果" 浮窗:
  - 匹配到的天体列表
  - [排除此天体] 按钮
  - [生成 80列报告] 按钮
```

---

## 8. 快捷键体系

### 8.1 全局快捷键 (窗口焦点内)

所有快捷键使用 `Qt.WindowShortcut`，仅在程序窗口获得焦点时生效。

| 快捷键 | 动作 | 分类 | 条件 |
|--------|------|------|------|
| `R` | 切换闪烁 开/关 | 核心 | 已加载图像 |
| `I` | 切换反色 | 核心 | 已加载图像 |
| `Y` | 标记当前候选为真 | 标记 | 有选中候选 |
| `N` | 标记当前候选为假 | 标记 | 有选中候选 |
| `1` | 显示新图 | 切换 | 已加载图像 |
| `2` | 显示旧图 | 切换 | 已加载图像 |
| `滚轮↑` | 放大 | 缩放 | 鼠标在图像区域 |
| `滚轮↓` | 缩小 | 缩放 | 鼠标在图像区域 |
| `中键拖拽` | 平移图像 | 导航 | 鼠标在图像区域 |

### 8.2 扩展快捷键

| 快捷键 | 动作 | 分类 |
|--------|------|------|
| `Ctrl+O` | 打开新图文件夹 | 文件 |
| `Ctrl+Shift+O` | 打开旧图文件夹 | 文件 |
| `Ctrl+B` | 切换侧边栏折叠 | 视图 |
| `Ctrl+,` | 打开设置 | 设置 |
| `Space` | 下一个候选体 | 导航 |
| `Shift+Space` | 上一个候选体 | 导航 |
| `F` | 适配窗口 (Fit to View) | 缩放 |
| `Ctrl+S` | 保存当前图像 | 文件 |
| `←` / `→` | 上/下一组图像配对 | 导航 |
| `Ctrl+E` | 导出 MPC 报告 | 报告 |

### 8.3 快捷键冲突预防

- 单字母快捷键 (`R`, `I`, `Y`, `N`) 在文本输入框获得焦点时自动失效
- 实现: `QAction.setShortcutContext(Qt.WindowShortcut)` + 文本框 focus 判断

---

## 9. 状态机与工作流

### 9.1 应用主状态机

```
┌─────────┐   加载文件夹   ┌──────────┐  批量对齐   ┌──────────┐
│  Empty  │──────────────►│  Loaded  │────────────►│ Aligned  │
│ (初始)  │                │ (已配对) │              │ (已对齐) │
└─────────┘                └──────────┘              └────┬─────┘
                                                          │
                                          ┌───────────────┘
                                          │ AI检测
                                          ▼
                            ┌──────────┐     ┌──────────────┐
                            │Detecting │────►│  Reviewing   │
                            │(检测中)  │     │ (复核候选体) │
                            └──────────┘     └───────┬──────┘
                                                      │
                                            标记/排除/导出
                                                      ▼
                                             ┌────────────┐
                                             │  Reported  │
                                             │ (已输出)   │
                                             └────────────┘
```

### 9.2 可疑目标列表操作状态

```
候选体生成 → [UNKNOWN] ──Y──→ [REAL]
                  │              ↕ (可反复修改)
                  N              Y
                  ↓              
               [BOGUS] ←────────┘

另: 如匹配 MPCORB → [KNOWN] (灰色，不参与 Y/N 标记)
```

### 9.3 数据流概览

```
新图文件夹 ──┐                                     ┌──→ 可疑目标列表
             ├─→ 配对 → 对齐 → 候选检测 → AI评分 ──┤
旧图文件夹 ──┘        ↑                    ↑        ├──→ MPCORB叠加显示
                      │                    │        └──→ MPC 80列报告
               仅移动旧图              CUDA推理
                                       ≤ 8GB
                                       
MPCORB文件 ────→ 位置计算 → 星等过滤 → 已知排除 ───→ 可疑列表精简
```

---

## 10. 视觉规范

### 10.1 色彩体系

采用**暗色主题 (Dark Theme)**，减少眼疲劳，对比度利于天文图像观察。

| 用途 | 色值 | 示例 |
|------|------|------|
| 背景 - 主 | `#1E1E1E` | 窗口背景 |
| 背景 - 图像区域 | `#141414` | 图像查看器背景 |
| 背景 - 面板 | `#252526` | 侧边栏/控制栏 |
| 文字 - 主 | `#D4D4D4` | 正文文字 |
| 文字 - 次 | `#808080` | 次要信息 |
| 强调 - 蓝 (新图) | `#2196F3` | 新图按钮激活、NEW标签 |
| 强调 - 橙 (旧图) | `#FF9800` | 旧图按钮激活、OLD标签 |
| 强调 - 绿 (真) | `#4CAF50` | 标记真、自动检测候选 |
| 强调 - 红 (假/选中) | `#F44336` | 标记假、选中候选框 |
| 强调 - 紫 (手动) | `#9C27B0` | 手动标记、反色状态 |
| 强调 - 灰 (已知) | `#757575` | 已知天体 |
| 强调 - 黄 (警告/AI) | `#FFEB3B` | 批量检测按钮、AI高分 |
| 边框 | `#3C3C3C` | 面板分割线 |

### 10.2 标记视觉样式

| 标记类型 | 形状 | 颜色 | 线宽 | 说明 |
|----------|------|------|------|------|
| AI 自动检测 | 圆圈 + 编号 | 绿色 `#4CAF50` | 2px | 默认标记 |
| 手动添加 | 圆圈 + 编号 | 紫色 `#9C27B0` | 2px | 用户手动标注 |
| 当前选中 | 圆圈 + 十字线 | 红色 `#F44336` | 3px | 加粗 + 十字线突出 |
| 已知天体 | 虚线圆 + 名称 | 灰色 `#757575` | 1px | 可隐藏 |
| MPCORB 叠加 | 虚线圆 + 名称 | 青色 `#00BCD4` | 1px | MPCORB 已知小行星 |
| 已标记为真 | 圆圈 + ✓ | 绿色 `#4CAF50` | 2px | 带对勾标识 |
| 已标记为假 | 圆圈 + ✗ | 红色半透明 | 1px | 降低视觉优先级 |

### 10.3 字体

| 用途 | 字体 | 大小 | 权重 |
|------|------|------|------|
| 界面文字 | 系统默认 / Microsoft YaHei | 12px | Regular |
| 候选编号 | Arial | 10px | Bold |
| 状态浮层 | Arial | 14px | Bold |
| MPC 报告 | Consolas / 等宽 | 12px | Regular |
| 坐标显示 | Consolas / 等宽 | 11px | Regular |

### 10.4 间距与尺寸

| 元素 | 值 |
|------|-----|
| 窗口内边距 | 4px |
| 面板内边距 | 2px |
| 按钮间距 | 4px |
| 按钮最小高度 | 28px |
| 侧边栏默认宽度 | 240px |
| 侧边栏最小宽度 | 200px |
| 控制栏高度 | 40px |
| 状态栏高度 | 24px |
| 标记圆圈半径 | 15px |

---

## 11. 可访问性与响应式

### 11.1 窗口缩放

| 分辨率 | 侧边栏 | 图像区域 | 控制栏 |
|--------|--------|----------|--------|
| 1920×1080 (FHD) | 240px | 1680px | 全宽 |
| 2560×1440 (QHD) | 280px | 2280px | 全宽 |
| 3840×2160 (4K) | 320px | 3520px | 全宽 |
| 1366×768 (笔记本) | 200px / 隐藏 | 1166px+ | 全宽 |

### 11.2 最小窗口尺寸

- **最小宽度**: 1024px
- **最小高度**: 768px
- 当窗口宽度 < 1200px 时，侧边栏自动折叠

### 11.3 高 DPI 支持

- 使用 `QApplication.setAttribute(Qt.AA_EnableHighDpiScaling)` 启用 HiDPI
- 图标使用 SVG 或 Emoji (无位图图标依赖)
- 标记线宽随 DPI 缩放

---

## 12. 需求追溯矩阵

| 需求编号 | 需求描述 | UI/UX 设计对应 | 章节 |
|----------|----------|---------------|------|
| R-01 | 按照新旧文件夹加载 FITS | 侧边栏: 新/旧图文件夹按钮 | §5.1, §4.2 |
| R-02 | 两个按钮显示新旧图 | 控制栏: [新图] [旧图] 按钮 | §5.2 |
| R-03 | 读取 FITS 文件头 | 状态栏坐标显示 + FITS头信息面板 | §4.1 |
| R-04 | 批量对齐 (新图为参考) | 侧边栏: [批量对齐] 按钮 + 进度条 | §4.2 |
| R-05 | 闪烁功能 + 可选速度 | 控制栏: 闪烁按钮 + 速度滑块 | §5.2 |
| R-06 | 直方图/屏幕拉伸 (不改原始数据) | 直方图拉伸面板 (§5.3) | §5.3 |
| R-07 | 反色 (持久状态) | 控制栏: 反色按钮 (toggle) + 状态浮层 | §5.2, §7.3 |
| R-08 | 可选批量降噪/伪平场 (另存为) | 批量处理对话框 (§5.7) | §5.7 |
| R-09 | AI 手动标记真假目标 | 控制栏: [真Y] [假N] + 快捷键 | §5.2, §8.1 |
| R-10 | 目标标记方框/十字线 | 图像查看器: 标记绘制系统 | §10.2 |
| R-11 | 标记另存为 (带拍摄日期) | 文件菜单: 另存为标记图 | §5.7 |
| R-12 | AI 全图检测 | 侧边栏: [批量检测] + 可疑目标列表 | §5.1, §5.4 |
| R-13 | 显存 ≤ 8GB + CUDA | 设置: 显存限制 (后端约束) | §5.5 |
| R-14 | MPCORB 叠加显示 | 图像查看器: 已知小行星叠加层 | §5.1, §10.2 |
| R-15 | 极限星等过滤 | 设置: 极限星等参数 | §5.5 |
| R-16 | 望远镜/天文台参数设置 | 设置对话框: 望远镜/天文台标签页 | §5.5 |
| R-17 | 已知排除 (MPCORB + 查询) | 可疑目标列表: 灰色已知 + 筛选 | §5.4 |
| R-18 | 右键查询 VSX/MPC/SIMBAD/TNS | 右键上下文菜单 | §5.9 |
| R-19 | MPC 80 列报告 | MPC 报告预览窗 | §5.8 |
| R-20 | 保存为整数 (16/32bit) | 批量处理: 位深度选项 | §5.7 |
| R-21 | 不修改 FITS 头 | 全局约束 (UI 显示提醒) | §5.7 |
| R-22 | 界面紧凑 | 全局布局: 最小边距/间距 | §4.3, §10.4 |
| R-23 | 可疑目标列表 (AI评分+坐标) | 可疑目标表格 Widget | §5.4 |
| R-24 | 中键拖拽 (新旧图同步) | 图像查看器: 中键事件 | §7.1, §7.2 |
| R-25 | 快捷键 r/n/y/滚轮/i | 快捷键体系 | §8.1 |
| R-26 | 所有 SpinBox 禁用滚轮 | NoScrollSpinBox 组件 | §6.1 |
| R-27 | 快捷键非全局 (窗口焦点) | `Qt.WindowShortcut` | §8.3 |
| R-28 | 定时爬 HMT (可选) | 设置: 计划任务配置 | §5.5 |

---

## 附录 A: 菜单栏完整结构

```
文件 (F)
├── 打开新图文件夹        Ctrl+O
├── 打开旧图文件夹        Ctrl+Shift+O
├── ────────────
├── 保存当前图像          Ctrl+S
├── 另存为标记图...       Ctrl+Shift+S
├── ────────────
├── 最近打开 ►
└── 退出                  Alt+F4

处理 (P)
├── 批量对齐
├── ────────────
├── 批量降噪/伪平场...
├── ────────────
└── 直方图拉伸            (面板切换)

AI (A)
├── 批量检测              F5
├── ────────────
├── 训练模型...
├── 加载模型...
└── 模型信息

查询 (Q)
├── 查询 VSX
├── 查询 MPC
├── 查询 SIMBAD
├── 查询 TNS
├── 人造卫星查询
├── ────────────
└── 生成 MPC 80列报告     Ctrl+E

视图 (V)
├── 切换侧边栏            Ctrl+B
├── ────────────
├── 适配窗口              F
├── 实际大小              Ctrl+0
├── 放大                  Ctrl++
├── 缩小                  Ctrl+-
├── ────────────
├── 显示候选标记          ☑
├── 显示 MPCORB 叠加     ☑
└── 显示已知天体          ☑

设置 (S)
├── 首选项...             Ctrl+,
├── ────────────
├── MPCORB 文件...
└── 计划任务...

帮助 (H)
├── 快捷键列表
├── 使用文档
├── ────────────
└── 关于 SCANN v2
```

---

## 附录 B: Widget 层级树

```
QMainWindow (MainWindow)
├── QMenuBar
├── QWidget (centralWidget)
│   └── QHBoxLayout
│       └── QSplitter (horizontal)
│           ├── CollapsibleSidebar (240px)
│           │   ├── QPushButton × 2 (新/旧文件夹)
│           │   ├── QPushButton × 2 (对齐/检测)
│           │   ├── QProgressBar
│           │   ├── QListWidget (图像配对列表)
│           │   └── SuspectTableWidget (可疑目标)
│           │       └── CoordinateLabel
│           └── QWidget (rightPanel)
│               └── QVBoxLayout
│                   ├── OverlayLabel (NEW/OLD 状态)
│                   ├── FitsImageViewer (弹性, stretch=1)
│                   │   └── QGraphicsScene
│                   │       ├── QGraphicsPixmapItem (图像)
│                   │       ├── QGraphicsEllipseItem[] (候选标记)
│                   │       └── MpcorbOverlay (叠加层)
│                   └── QHBoxLayout (controlBar, 40px)
│                       ├── QPushButton (新图/旧图/闪烁/反色)
│                       ├── BlinkSpeedSlider
│                       ├── QSpacerItem (弹性)
│                       └── QPushButton (真/假/下一个)
└── QStatusBar
    ├── QLabel (当前图: NEW/OLD)
    ├── CoordinateLabel (像素坐标)
    ├── CoordinateLabel (天球坐标)
    └── QLabel (缩放百分比)
```

---

## 附录 C: 对话框/浮窗清单

| 名称 | 类型 | 触发 | 模态 |
|------|------|------|------|
| SettingsDialog | QDialog | 菜单/Ctrl+, | 模态 |
| TrainingDialog | QDialog | 菜单 AI > 训练 | 非模态 |
| BatchProcessDialog | QDialog | 菜单 处理 > 批量 | 模态 |
| MpcReportDialog | QDialog | 右键 > MPC 报告 | 非模态 |
| QueryResultPopup | QFrame (浮窗) | 右键查询返回 | 非模态 |
| HistogramPanel | QDockWidget | 菜单/按钮 | 非模态/可停靠 |
| ShortcutHelpDialog | QDialog | 菜单 帮助 | 非模态 |

---

## 附录 D: 信号-槽连接概览

```
文件夹按钮.clicked  ────→  FileManager.scan_fits_folder()
                           ↓
                    file_list 更新
                           ↓
file_list.currentRowChanged ──→ 加载图像配对 → ImageViewer.set_image_data()

btn_blink.clicked  ────→  BlinkService.toggle() ──→ QTimer start/stop
QTimer.timeout     ────→  BlinkService.tick()   ──→ 切换 NEW/OLD 显示

btn_detect.clicked ────→  DetectionPipeline.process_pair()
                          ↓ (工作线程)
                    完成信号 → SuspectTableWidget 更新

suspect_list.clicked ──→  ImageViewer.centerOn(candidate)
                         ImageViewer.draw_markers(selected=idx)

ImageViewer.right_click ──→ QMenu.exec() ──→ QueryService.query_xxx()
                                              ↓
                                        QueryResultPopup 显示

btn_mark_real.clicked ──→ candidate.verdict = REAL
                         SuspectTableWidget 刷新行状态
```

---

*文档结束。本设计遵循需求文档和架构设计中的所有约束，每项需求均可在追溯矩阵 (§12) 中找到对应设计。*
